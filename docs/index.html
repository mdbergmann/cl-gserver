<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml' xml:lang='en' lang='en'>
<head>
<title>sento documentation</title>
<link type='text/css' href='style.css' rel='stylesheet'/>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<script src="jquery.min.js"></script>
<script src="toc.min.js"></script>
<script type="text/x-mathjax-config">
     MathJax.Hub.Config({
       tex2jax: {
         inlineMath: [['$','$']],
         processEscapes: true
       }
     });
   </script>
   <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML">
   </script>
   </head>
<body>
<div id="content-container">
<div id="toc">
<div id="page-toc">
</div>
<div id="toc-footer"><ul><li><a href="https://github.com/melisgl/mgl-pax">[generated by MGL-PAX]</a></li></ul></div>
</div>
<div id="content">
<p><a id="x-28SENTO-2EDOCS-3A-40SENTO-20MGL-PAX-3ASECTION-29"></a>
<a id="SENTO.DOCS:@SENTO%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#SENTO.DOCS:@README%20MGL-PAX:SECTION" title="Introduction">&#8594;</a> <a href="#SENTO.DOCS:@SENTO%20MGL-PAX:SECTION" title="sento documentation">&#8634;</a></span></span></p>

<h1><a href="#SENTO.DOCS:@SENTO%20MGL-PAX:SECTION">sento documentation</a></h1>

<h2>Table of Contents</h2>

<ul>
<li><a href="#SENTO.DOCS:@README%20MGL-PAX:SECTION" title="Introduction">1 Introduction</a></li>
<li><a href="#SENTO.DOCS:@API%20MGL-PAX:SECTION" title="API documentation">2 API documentation</a>

<ul>
<li><a href="#SENTO.ACTOR-SYSTEM:@ACTOR-SYSTEM%20MGL-PAX:SECTION" title="Actor-System">2.1 Actor-System</a></li>
<li><a href="#SENTO.ACTOR-CONTEXT:@ACTOR-CONTEXT%20MGL-PAX:SECTION" title="Actor-Context">2.2 Actor-Context</a>

<ul>
<li><a href="#SENTO.ACTOR-CONTEXT:@AC-PROTOCOL%20MGL-PAX:SECTION" title="Actor-Context protocol">2.2.1 Actor-Context protocol</a></li>
</ul></li>
<li><a href="#SENTO.ACTOR:@ACTOR%20MGL-PAX:SECTION" title="Actor">2.3 Actor</a>

<ul>
<li><a href="#SENTO.ACTOR-CELL:@ACTOR-CELL%20MGL-PAX:SECTION" title="Actor-Cell">2.3.1 Actor-Cell</a></li>
<li><a href="#SENTO.MESSAGEB:@MESSAGE-BOX-BASE%20MGL-PAX:SECTION" title="Message-box base class">2.3.2 Message-box base class</a></li>
<li><a href="#SENTO.MESSAGEB:@MESSAGE-BOX%2FBT%20MGL-PAX:SECTION" title="Message-box threaded">2.3.3 Message-box threaded</a></li>
<li><a href="#SENTO.MESSAGEB:@MESSAGE-BOX%2FDP%20MGL-PAX:SECTION" title="Message-box dispatched">2.3.4 Message-box dispatched</a></li>
<li><a href="#SENTO.FUTURE:@FUTURE%20MGL-PAX:SECTION" title="Future (delayed-computation)">2.3.5 Future (delayed-computation)</a></li>
</ul></li>
<li><a href="#SENTO.AGENT:@AGENT%20MGL-PAX:SECTION" title="Agent">2.4 Agent</a>

<ul>
<li><a href="#SENTO.AGENT.HASH:@HASH-AGENT%20MGL-PAX:SECTION" title="Hash-table agent">2.4.1 Hash-table agent</a></li>
<li><a href="#SENTO.AGENT.ARRAY:@ARRAY-AGENT%20MGL-PAX:SECTION" title="Array/Vector agent">2.4.2 Array/Vector agent</a></li>
</ul></li>
<li><a href="#SENTO.DISPATCHER:@DISPATCHER%20MGL-PAX:SECTION" title="Dispatcher">2.5 Dispatcher</a>

<ul>
<li><a href="#SENTO.DISPATCHER:@SHARED-DISPATCHER%20MGL-PAX:SECTION" title="Shared dispatcher">2.5.1 Shared dispatcher</a></li>
</ul></li>
<li><a href="#SENTO.ROUTER:@ROUTER%20MGL-PAX:SECTION" title="Router">2.6 Router</a></li>
<li><a href="#SENTO.EVENTSTREAM:@EVENTSTREAM%20MGL-PAX:SECTION" title="Eventstream">2.7 Eventstream</a></li>
<li><a href="#SENTO.TASKS:@TASKS%20MGL-PAX:SECTION" title="Tasks">2.8 Tasks</a></li>
<li><a href="#SENTO.CONFIG:@CONFIG%20MGL-PAX:SECTION" title="Config">2.9 Config</a></li>
</ul></li>
</ul>

<h6>[in package SENTO.DOCS]</h6>

<p><a id="x-28SENTO-2EDOCS-3A-40README-20MGL-PAX-3ASECTION-29"></a>
<a id="SENTO.DOCS:@README%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#SENTO.DOCS:@SENTO%20MGL-PAX:SECTION" title="sento documentation">&#8592;</a> <a href="#SENTO.DOCS:@SENTO%20MGL-PAX:SECTION" title="sento documentation">&#8593;</a> <a href="#SENTO.DOCS:@API%20MGL-PAX:SECTION" title="API documentation">&#8594;</a> <a href="#SENTO.DOCS:@README%20MGL-PAX:SECTION" title="Introduction">&#8634;</a></span></span></p>

<h2><a href="#SENTO.DOCS:@README%20MGL-PAX:SECTION">1 Introduction</a></h2>

<p><a id="x-28SENTO-2EDOCS-3AREADME-2EMD-20-28MGL-PAX-3AINCLUDE-20-23P-22-2FUsers-2Fmbergmann-2FDevelopment-2FMySources-2Fcl-gserver-2FREADME-2Emd-22-29-29"></a>
<a id="SENTO.DOCS:README.MD%20%28MGL-PAX:INCLUDE%20%23P%22%2FUsers%2Fmbergmann%2FDevelopment%2FMySources%2Fcl-gserver%2FREADME.md%22%29"></a></p>

<p><img src="https://github.com/mdbergmann/cl-gserver/workflows/CI/badge.svg?branch=master" alt="CI" /></p>

<h3>Introduction - Actor framework featuring actors and agents</h3>

<p><strong>Sento</strong> is a 'message passing' library/framework with actors similar to Erlang or Akka. It supports creating systems that should work reactive, require parallel computing and event based message handling.</p>

<p>sento features:</p>

<ul>
<li>Actors with <code>ask</code> and <code>tell</code> operations. <code>ask</code> can be asynchronous or synchronous.</li>
<li>Agents: Agents are a specialization of Actors for wrapping state with a standardized interface of <code>init</code>, <code>get</code> and <code>set</code>. There are also specialized Agents for CLs array and hash-map.</li>
<li>Router: Router offers a similar interface as Actor with <code>ask</code> and <code>tell</code> but collects multiple Actors for load-balancing.</li>
<li>EventStream: all Actors and Agents are connected to an EventStream and can subscribe to messages or publish messages.</li>
<li>Tasks: a simple API for concurrency.</li>
</ul>

<h3>Version history</h3>

<p><strong>Version 2.1.0 (17.11.2022):</strong> Reworked the <code>future</code> package. Nicer symtax and futures can now be mapped.</p>

<p><strong>Version 2.0.0 (16.8.2022):</strong> Rename to &quot;Sento&quot;. Incompatible change due to package names and system have changed.</p>

<p><strong>Version 1.12.2 (29.5.2022):</strong> Removed the logging abstraction again. Less code to maintain. log4cl is featureful enough for users to either use it, or use something else in the applications that are based on sento.</p>

<p><strong>Version 1.12.1 (25.5.2022):</strong> Shutdown and stop of actor, actor context and actor system can now wait for a full shutdown/stop of all actors to really have a clean system shutdown.</p>

<p><strong>Version 1.12.0 (26.2.2022):</strong> Refactored and cleaned up the available <code>actor-of</code> facilities. There is now only one. If you used the macro before, you may have to adapt slightly.</p>

<p><strong>Version 1.11.1 (25.2.2022):</strong> Minor additions to <code>actor-of</code> macro to allow specifying a <code>destroy</code> function.</p>

<p><strong>Version 1.11.0 (16.1.2022):</strong> Changes to <code>AC:FIND-ACTORS</code>. Breaking API change. See API documentation for details.</p>

<p><strong>Version 1.10.0:</strong> Logging abstraction. Use your own logging facility. sento doesn't lock you in but provides support for log4cl. Support for other logging facilities can be easily added so that the logging of sento  will use your chosen logging library. See below for more details.</p>

<p><strong>Version 1.9.0:</strong> Use wheel timer for <code>ask</code> timeouts.</p>

<p><strong>Version 1.8.2:</strong> atomic add/remove of actors in actor-context.</p>

<p><strong>Version 1.8.0:</strong> hash-agent interface changes. Added array-agent.</p>

<p><strong>Version 1.7.6:</strong> Added cl:hash-table based agent with similar API interface.</p>

<p><strong>Version 1.7.5:</strong> Allow agent to specify the dispatcher to be used.</p>

<p><strong>Version 1.7.4:</strong> more convenience additions for task-async (completion-handler)</p>

<p><strong>Version 1.7.3:</strong> cleaned up dependencies. Now sento works on SBCL, CCL, LispWorks, Allegro and ABCL</p>

<p><strong>Version 1.7.2:</strong> allowing to choose the dispatcher strategy via configuration</p>

<p><strong>Version 1.7.1:</strong> added possibility to create additional and custom dispatchers. I.e. to be used with <code>tasks</code>.</p>

<p><strong>Version 1.7.0:</strong> added tasks abstraction facility to more easily deal with asynchronous and concurrent operations.</p>

<p><strong>Version 1.6.0:</strong> added eventstream facility for building event based systems. Plus documentation improvements.</p>

<p><strong>Version 1.5.0:</strong> added configuration structure. actor-system can now be created with a configuration. More configuration options to come.</p>

<p><strong>Version 1.4.1:</strong> changed documentation to the excellent <a href="https://github.com/melisgl/mgl-pax" >mgl-pax</a></p>

<p><strong>Version 1.4:</strong> convenience macro for creating actor. See below for more details</p>

<p><strong>Version 1.3.1:</strong> round-robin strategy for router</p>

<p><strong>Version 1.3:</strong> agents can be created in actor-system</p>

<p><strong>Version 1.2:</strong> introduces a breaking change</p>

<p><code>ask</code> has been renamed to <code>ask-s</code>.</p>

<p><code>async-ask</code> has been renamed to <code>ask</code>.</p>

<p>The proposed default way to query for a result from another actor should
be an asynchronous <code>ask</code>. <code>ask-s</code> (synchronous) is
of course still possible.</p>

<p><strong>Version 1.0</strong> of <code>sento</code> library comes with quite a
few new features (compared to the previous 0.x versions). 
One of the major new features is that an actor is not
bound to it's own message dispatcher thread. Instead, when an
<code>actor-system</code> is set-up, actors can use a shared pool of
message dispatchers which effectively allows to create millions of
actors.</p>

<p>It is now possible to create actor hierarchies. An actor can have child
actors. An actor now can also 'watch' another actor to get notified
about it's termination.</p>

<p>It is also possible to specify timeouts for the <code>ask-s</code> and
<code>ask</code> functionality.</p>

<p>This new version is closer to Akka (the actor model framework on the
JVM) than to GenServer on Erlang. This is because Common Lisp from a
runtime perspective is closer to JVM than to Erlang/OTP. Threads in
Common Lisp are heavy weight OS threads rather than user-space low
weight 'Erlang' threads (I'd like to avoid 'green threads', because
threads in Erlang are not really green threads). While on Erlang it is
easily possible to spawn millions of processes/threads and so each actor
(GenServer) has its own process, this model is not possible when the
threads are OS threads, because of OS resource limits. This is the main
reason for working with the message dispatcher pool instead.</p>

<p>But let's jump right into it. I'll explain more later.</p>

<h3>Getting hands-on</h3>

<h4>Creating an actor-system</h4>

<p>To use the shared dispatcher pool we have to create an
<code>actor-system</code> first.</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_143.html#IDX430" class="symbol"><i><span class="symbol">defvar</span></i></a> <span class="special">*system*</span> <span class="paren2">(<span class="code">asys:make-actor-system</span>)</span></span>)</span></span></code></pre>

<p>When we eval <code>*system*</code> in the repl we see a bit of the structure:</p>

<pre><code>#&lt;ACTOR-SYSTEM shared-workers: 4, user actors: 0, internal actors: 0&gt;</code></pre>

<p>So the <code>actor-system</code> has by default four shared message
dispatcher workers. Depending on how busy the system tends to be this
default can of course be increased.</p>

<p>An optional configuration can be passed to the actor-system factory function. See API documentation.</p>

<ol>
<li><p>Shutting down the system</p>

<p>Shutting down an actor system may be necessary depending on how
it's used. It can be done by:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">ac:shutdown <span class="special">*system*</span></span>)</span></span></code></pre>

<p>This will stop all dispatcher workers and all other actors that have
been spawned in the system.</p></li>
</ol>

<h4>Creating actors</h4>

<p>Actors kind of live within an <code>actor-context</code>. An
<code>actor-context</code> contains a collection (of actors) and defines a Common
Lisp protocol that defines a set of generic functions for creating, removing and finding actors in an <code>actor-context</code>.</p>

<p>There are two 'things' that host an <code>actor-context</code>. This
is:</p>

<ol>
<li>the <code>actor-system</code>. Creating actors on the <code>actor-system</code> will create root actors.</li>
<li>the <code>actor</code>. Creating actors on the context of an actor will create a child actor.</li>
</ol>

<p>Let's create an actor.</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">ac:actor-of <span class="special">*system*</span> <span class="keyword">:name</span> <span class="string">"answerer"</span>
  <span class="keyword">:receive</span>
  <span class="paren2">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_330.html#IDX1006" class="symbol"><i><span class="symbol">lambda</span></i></a> <span class="paren3">(<span class="code">self msg state</span>)</span>
    <span class="paren3">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_141.html#IDX422" class="symbol"><i><span class="symbol">let</span></i></a> <span class="paren4">(<span class="code"><span class="paren5">(<span class="code">output <span class="paren6">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_75.html#IDX176" class="symbol">format</a> <a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_6.html#SEC6" class="symbol">nil</a> <span class="string">"Hello ~a"</span> msg</span>)</span></span>)</span></span>)</span>
      <span class="paren4">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_75.html#IDX176" class="symbol">format</a> <a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_266.html#IDX704" class="symbol">t</a> <span class="string">"~a~%"</span> output</span>)</span>
      <span class="paren4">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_83.html#IDX221" class="symbol">cons</a> output state</span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<p>This creates a root actor on the <code>*system*</code>. Notice that the actor is not assigned to a variable. It is now registered in the system. The <code>:receive</code> key argument to the <code>actor-of</code> macro is a function which does the main message processing of an actor. The parameters to the 'receive' function are the tuple:</p>

<ol>
<li><code>self</code> - the instance of the actor</li>
<li><code>msg</code> - the received message of when this 'receive' function is called</li>
<li><code>state</code> - the current state of the actor</li>
</ol>

<p><code>actor-of</code> also allows to specify the initial state by using the <code>:state</code> key, a name, and a custom actor type. By default a standard actor of type <code>'actor</code> is created. But you can subclass <code>'actor</code> and specify your own. It is also possible to add 'after initialization' code using the <code>:init</code> key which takes a lambda with the actor instance as parameter.</p>

<p>The return value of the 'receive' function should also be familiar. It is the <code>cons</code> with <code>car</code> being sent back to sender (in case of ask/ask-s) and <code>cdr</code> set as the new state of the actor.</p>

<p>The <code>actor-of</code> macro still returns the actor as can be seen on the repl when this is executed. So it is of course possible to store the actor in a dynamic or lexical context. However, when the lexical context ends, the actor will still live as part of the actor context/system.</p>

<p>Here we see a few details of the actor. Among which is the name and also the type of message-box it uses. By default it is a <code>message-box/dp</code> which is the type of a shared message dispatcher message-box.</p>

<pre><code><span class="code">#&lt;ACTOR answerer, running: T, state: NIL, message-box: #&lt;MESSAGE-BOX/DP mesgb-9541, processed messages: 0, max-queue-size: 0, queue: #&lt;QUEUE-UNBOUNDED #x3020029918FD&gt;&gt;&gt;</span></code></pre>

<p>Had we stored the actor to a variable, say <code>*answerer*</code> we
can create a child actor of that by doing:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">ac:actor-of <span class="special">*answerer*</span> <span class="keyword">:name</span> <span class="string">"child-answerer"</span>
    <span class="keyword">:receive</span> 
    <span class="paren2">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_330.html#IDX1006" class="symbol"><i><span class="symbol">lambda</span></i></a> <span class="paren3">(<span class="code">self msg state</span>)</span>
        <span class="paren3">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_141.html#IDX422" class="symbol"><i><span class="symbol">let</span></i></a> <span class="paren4">(<span class="code"><span class="paren5">(<span class="code">output <span class="paren6">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_75.html#IDX176" class="symbol">format</a> <a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_6.html#SEC6" class="symbol">nil</a> <span class="string">"~a"</span> <span class="string">"Hello-child ~a"</span> msg</span>)</span></span>)</span></span>)</span>
            <span class="paren4">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_75.html#IDX176" class="symbol">format</a> <a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_266.html#IDX704" class="symbol">t</a> <span class="string">"~a~%"</span> output</span>)</span>
            <span class="paren4">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_83.html#IDX221" class="symbol">cons</a> output state</span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<p>This will create a new actor on the context of the parent actor. The
context can be specified with just the parent actor instance <code>*answerer*</code>.</p>

<h5>Dispatchers <code>:pinned</code> vs. <code>:shared</code></h5>

<p>Dispatchers are somewhat alike thread pools. Dispatchers of the <code>:shared</code> type are a pool of workers. Workers are actors using a <code>:pinned</code> dispatcher. <code>:pinned</code> just means that an actor spawns its own mailbox thread.</p>

<p>So <code>:pinned</code> and <code>:shared</code> are types of dispatchers. <code>:pinned</code> spawns its own mailbox thread, <code>:shared</code> uses a worker pool to handle the mailbox messages.</p>

<p>By default an actor created using <code>actor-of</code> uses a <code>:shared</code> dispatcher type which uses the shared message dispatcher that is automatically setup in the system.<br/>
When creating an actor it is possible to specify the <code>dispatcher-id</code>. This parameter specifies which 'dispatcher' should handle the mailbox queue/messages.</p>

<p>Please see below for more info on dispatchers.</p>

<h4>Finding actors in the context</h4>

<p>If actors are not directly stored in a dynamic or lexical context they
can still be looked up and used. The <code>actor-context</code> protocol
contains a function <code>find-actors</code> which works like this:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">first <span class="paren2">(<span class="code">ac:find-actors <span class="special">*system*</span> <span class="string">"answerer"</span></span>)</span></span>)</span></span></code></pre>

<p>See additional parameters and options here: <a href="https://mdbergmann.github.io/cl-gserver/index.html#x-28CL-GSERVER-2EACTOR-CONTEXT-3AFIND-ACTORS-20GENERIC-FUNCTION-29" >API documentation</a></p>

<pre><code><span class="code">#&lt;ACTOR answerer, running: T, state: NIL, message-box: #&lt;MESSAGE-BOX/DP mesgb-9687, processed messages: 0, max-queue-size: 0, queue: #&lt;QUEUE-UNBOUNDED #x30200263C95D&gt;&gt;&gt;</span></code></pre>

<p>This function only does a simple flat search. The functionality of
looking up an actor in the system generally will be expanded upon.</p>

<h4>tell, ask-s and ask</h4>

<p>Let's send some messages.</p>

<h5>tell</h5>

<p><code>tell</code> is a fire-and-forget kind of send type. It
doesn't expect a result in return.</p>

<p>And because of that, and in order to demonstrate it does something,
it has to have a side-effect. So it dumps some string to the console
using <code>format</code>, because we couldn't otherwise <code>tell</code> if
the message was received and processed (see the
<code>*answerer*</code> actor definitions above).</p>

<pre><code><span class="code">CL-USER&gt; <span class="paren1">(<span class="code">act:tell <span class="special">*answerer*</span> <span class="string">"Foo"</span></span>)</span>
T
CL-USER&gt; 
Hello Foo</span></code></pre>

<p>So we see that <code>tell</code> returns immediately with <code>T</code>. But
to see the 'Hello Foo' it takes another hit on the return key,
because the REPL is not asynchronous.</p>

<h5>tell with sender</h5>

<p><code>tell</code> accepts a 'sender', which has to be an actor. So
we can do like this:</p>

<pre><code><span class="code">CL-USER&gt; <span class="paren1">(<span class="code">act:tell <span class="special">*child-answerer*</span> <span class="string">"Foo"</span> <span class="special">*answerer*</span></span>)</span>
T
CL-USER&gt; 
Hello-child Foo
Hello Hello-child Foo</span></code></pre>

<p>This sends \&quot;Foo\&quot; to <code>*child-answerer*</code>, but <code>*child-answerer*</code>
sends the response to <code>*answerer*</code>. So we see outputs of both
actors.</p>

<h5>ask-s</h5>

<p><code>ask-s</code> blocks until the message was processed by the
actor. This call returns the <code>car</code> part of the <code>cons</code> return of the
behavior function. Insofar an <code>ask-s</code> call is more
resource intensive than just a <code>tell</code>.</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">act:ask-s <span class="special">*answerer*</span> <span class="string">"Bar"</span></span>)</span></span></code></pre>

<p>Will respond with: 'Hello Bar'</p>

<h5>ask</h5>

<p><code>ask</code> combines both <code>ask-s</code> and
<code>tell</code>. From <code>ask-s</code> it 'inherits' returning
a result, even though it's a future result. Internally it is
implemented using <code>tell</code>. In order to wait for a result a
temporary actor is spawned that waits until it receives the result
from the actor where the message was sent to. With this received
result the future is fulfilled. So <code>ask</code> is async, it
returns immediately with a <code>future</code>. That
<code>future</code> can be queried until it is fulfilled. Better is
though to setup an <code>fcompleted</code> handler function on it.</p>

<p>So we can do:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">future:fcompleted
          <span class="paren2">(<span class="code">act:ask <span class="special">*answerer*</span> <span class="string">"Buzz"</span></span>)</span>
          <span class="paren2">(<span class="code">result</span>)</span>
            <span class="paren2">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_75.html#IDX176" class="symbol">format</a> <a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_266.html#IDX704" class="symbol">t</a> <span class="string">"Received result: ~a~%"</span> result</span>)</span></span>)</span></span></code></pre>

<p>Well, one step at a time:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">act:ask <span class="special">*answerer*</span> <span class="string">"Buzz"</span></span>)</span></span></code></pre>

<p>Returns with:</p>

<pre><code><span class="code">#&lt;FUTURE promise: #&lt;PROMISE finished: NIL errored: NIL forward: NIL #x302002EAD6FD&gt;&gt;</span></code></pre>

<p>Then we can setup a completion handler on the future:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">future:fcompleted 
          <a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_63.html#IDX107" class="symbol">*</a>
          <span class="paren2">(<span class="code">result</span>)</span>
            <span class="paren2">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_75.html#IDX176" class="symbol">format</a> <a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_266.html#IDX704" class="symbol">t</a> <span class="string">"Received result: ~a~%"</span> result</span>)</span></span>)</span>)</span></code></pre>

<p>Remember '*' is the last result in the REPL which is the future
here.</p>

<p>This will print after a bit:</p>

<pre><code><span class="code">Hello Buzz
Received result: Hello Buzz</span></code></pre>

<p><strong>Mapping futures with fmap</strong></p>

<p>Let's asume we have such a simple actor that just increments the value passed to it.</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defparameter</span></i> <span class="special">*incer*</span>
  <span class="paren2">(<span class="code">actor-of <span class="special">*sys*</span>
            <span class="keyword">:receive</span> <span class="paren3">(<span class="code"><i><span class="symbol">lambda</span></i> <span class="paren4">(<span class="code">self value state</span>)</span>
                       <span class="paren4">(<span class="code">declare <span class="paren5">(<span class="code">ignore self state</span>)</span></span>)</span>
                       <span class="paren4">(<span class="code">cons <span class="paren5">(<span class="code">1+ value</span>)</span> state</span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<p>Since <code>ask</code> returns a future it is possible to map multiple <code>ask</code> operations like this:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">-&gt; <span class="paren2">(<span class="code">ask <span class="special">*incer*</span> 0</span>)</span>
  <span class="paren2">(<span class="code">fmap <span class="paren3">(<span class="code">result</span>)</span>
      <span class="paren3">(<span class="code">ask <span class="special">*incer*</span> result</span>)</span></span>)</span>
  <span class="paren2">(<span class="code">fmap <span class="paren3">(<span class="code">result</span>)</span>
      <span class="paren3">(<span class="code">ask <span class="special">*incer*</span> result</span>)</span></span>)</span>
  <span class="paren2">(<span class="code">fcompleted <span class="paren3">(<span class="code">result</span>)</span>
      <span class="paren3">(<span class="code">format t <span class="string">"result: ~a~%"</span> result</span>)</span>
    <span class="paren3">(<span class="code">assert <span class="paren4">(<span class="code">= result 3</span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<h4>ask-s and ask with timeout</h4>

<p>A timeout (in seconds) can be specified for both <code>ask-s</code> and
<code>ask</code> and is done like so:</p>

<p>To demonstrate this we could setup an example 'sleeper' actor:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">ac:actor-of <span class="special">*system*</span> 
    <span class="keyword">:receive</span> 
    <span class="paren2">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_330.html#IDX1006" class="symbol"><i><span class="symbol">lambda</span></i></a> <span class="paren3">(<span class="code">self msg state</span>)</span>
        <span class="paren3">(<span class="code">sleep 5</span>)</span></span>)</span></span>)</span></span></code></pre>

<p>If we store this to <code>*sleeper*</code> and do the following, the
<code>ask-s</code> will return a <code>handler-error</code> with an
<code>ask-timeout</code> condition.</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">act:ask-s <span class="special">*sleeper*</span> <span class="string">"Foo"</span> <span class="keyword">:time-out</span> 2</span>)</span></span></code></pre>

<pre><code><span class="code"><span class="paren1">(<span class="code"><span class="keyword">:HANDLER-ERROR</span> . #&lt;CL-GSERVER.UTILS:ASK-TIMEOUT #x30200319F97D&gt;</span>)</span></span></code></pre>

<p>This works similar with the <code>ask</code> only that the future will
be fulfilled with the <code>handler-error</code> <code>cons</code>.</p>

<p>To get a readable error message of the condition we can do:</p>

<pre><code><span class="code">CL-USER&gt; <span class="paren1">(<span class="code">format t <span class="string">"~a"</span> <span class="paren2">(<span class="code">cdr *</span>)</span></span>)</span>
A timeout set to 2 seconds occurred. Cause: 
#&lt;BORDEAUX-THREADS:TIMEOUT #x302002FAB73D&gt; </span></code></pre>

<p>Note that <code>ask-s</code> uses the calling thread for the timeout checks.<br/>
<code>ask</code> uses a wheel timer to handle timeouts. The default resolution for <code>ask</code> timeouts is 500ms with a maximum size of wheel slots (registered timeouts) of 1000. What this means is that you can have timeouts of a multiple of 500ms and 1000 <code>ask</code> operations with timeouts. This default can be tweaked when creating an actor-system, see <a href="https://mdbergmann.github.io/cl-gserver/index.html#x-28CL-GSERVER-2EACTOR-SYSTEM-3A-2ADEFAULT-CONFIG-2A-20-28VARIABLE-29-29" >API documentation</a> for more details.</p>

<h4>Long running operations in <code>receive</code></h4>

<p>Be careful with doing long running computations in the
<code>receive</code> function message handler, because it will block
message processing. It is advised to use a third-party thread-pool or a
library like <em>lparallel</em> to do the computations with and return early
from the <code>receive</code> message handler.</p>

<p>Considering the required <code>cons</code> return result of the
<code>receive</code> function, in case a result computation is delegated
to a thread-pool the <code>receive</code> function should return with
<code>(cons :no-reply &lt;state&gt;)</code>. The <code>:no-reply</code> will instruct the actor to
<em>not</em> send a result to a sender automatically should a sender be
available (for the cases of <code>tell</code> or <code>ask</code>). The
computation result can be 'awaited' for in an asynchronous manner and
a response to <code>*sender*</code> can be sent manually by just doing a
<code>(tell *sender* &lt;my-computation-result&gt;)</code>. The sender of the original
message is set to the dynamic variable <code>*sender*</code>.</p>

<p>Due to an asynchronous callback of a computation running is a separate
thread, the <code>*sender*</code> must be copied into a lexical environment because
at the time of when the callback is executed the <code>*sender*</code> can have a
different value.</p>

<p>This behavior must be part of the messaging protocol that is being
defined for the actors at play.</p>

<h4>Changing behavior</h4>

<p>An actor can change behavior. The behavior is just a lambda that has to
take three parameters:</p>

<ol>
<li>the actor's instance - usually called <code>self</code></li>
<li>the received message - maybe call <code>msg</code>?</li>
<li>the current state of the actor</li>
</ol>

<p>The behavior then can pattern match (or do some matching by other means)
on the received message alone, or in combination with the current state.</p>

<p>The default behavior of the actor is given on actor construction using
the default constructor <code>make-actor</code>.</p>

<p>During the lifetime of an actor the behavior can be changed using
<code>become</code>.</p>

<p>So we remember the <code>*answerer*</code> which responds with 'Hello Foo' when
we send <code>(act:ask-s *answerer* &quot;Foo&quot;)</code>. We can now change the behavior
with:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">act:become <span class="special">*answerer*</span> 
            <span class="paren2">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_330.html#IDX1006" class="symbol"><i><span class="symbol">lambda</span></i></a> <span class="paren3">(<span class="code">self msg state</span>)</span>
              <span class="paren3">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_83.html#IDX221" class="symbol">cons</a> <span class="paren4">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_75.html#IDX176" class="symbol">format</a> <a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_6.html#SEC6" class="symbol">nil</a> <span class="string">"my new behavior for: ~a"</span> msg</span>)</span> state</span>)</span></span>)</span></span>)</span></span></code></pre>

<p>When we now send <code>(act:ask-s *answerer* &quot;Foo&quot;)</code> we will get the
response: 'my new behavior for: Foo'.</p>

<p><strong>Reverting <code>become</code> / <code>unbecome</code></strong></p>

<p>To revert back to the default behavior as defined by the
<code>receive</code> function of the constructor you may call
<code>unbecome</code>.</p>

<h4>Creating actors without a system</h4>

<p>It is still possible to create actors without a system. This is how you
do it:</p>

<pre><code><span class="code"><span class="comment">;; make an actor
</span><span class="paren1">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_143.html#IDX430" class="symbol"><i><span class="symbol">defvar</span></i></a> <span class="special">*my-actor*</span> <span class="paren2">(<span class="code">act:make-actor <span class="paren3">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_330.html#IDX1006" class="symbol"><i><span class="symbol">lambda</span></i></a> <span class="paren4">(<span class="code">self msg state</span>)</span>
                                     <span class="paren4">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_83.html#IDX221" class="symbol">cons</a> <span class="string">"Foo"</span> state</span>)</span></span>)</span>
                                   <span class="keyword">:name</span> <span class="string">"Lone-actor"</span></span>)</span></span>)</span>
<span class="comment">;; setup a thread based message box
</span><span class="paren1">(<span class="code">setf <span class="paren2">(<span class="code">act-cell:msgbox <span class="special">*my-actor*</span></span>)</span> 
      <span class="paren2">(<span class="code">make-instance 'mesgb:message-box/bt</span>)</span></span>)</span></span></code></pre>

<p>You have to take care yourself about stopping the actor and freeing
resources.</p>

<h3>Agents</h3>

<p>An Agent is a specialized Actor. It is meant primarily for maintaining
state and comes with some conveniences to do that.</p>

<p>To use an Agent import <code>sento.agent</code> package.</p>

<p>There is no need to subclass an Agent. Rather create a facade to
customize an agent. See below.</p>

<p>An Agent provides three functions to use it.</p>

<ul>
<li><code>make-agent</code> creates a new agent. Optionally specify an <code>actor-context</code> or define the kind of dispatcher the agent should use.</li>
<li><code>agent-get</code> retrieves the current state of the agent. This directly
delivers the state of the agent for performance reasons. There is no
message handling involved.</li>
<li><code>agent-update</code> updates the state of the agent</li>
<li><code>agent-update-and-get</code> updates the agent state and returns the new state.</li>
</ul>

<p>All four take a lambda. The lambda for <code>make-agent</code> does not take a
parameter. It should return the initial state of the agent. <code>agent-get</code>
and <code>agent-update</code> both take a lambda that must support one parameter.
This parameter represents the current state of the agent.</p>

<p>Let's make a simple example:</p>

<p>First create an agent with an initial state of <code>0</code>.</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defparameter</span></i> <span class="special">*my-agent*</span> <span class="paren2">(<span class="code">make-agent <span class="paren3">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_330.html#IDX1006" class="symbol"><i><span class="symbol">lambda</span></i></a> <span class="paren4">(<span class="code"></span>)</span> 0</span>)</span></span>)</span></span>)</span></span></code></pre>

<p>Now update the state several times (<code>agent-update</code> is asynchronous and
returns <code>t</code> immediately):</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">agent-update <span class="special">*my-agent*</span> <span class="paren2">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_330.html#IDX1006" class="symbol"><i><span class="symbol">lambda</span></i></a> <span class="paren3">(<span class="code">state</span>)</span> <span class="paren3">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_63.html#IDX103" class="symbol">1+</a> state</span>)</span></span>)</span></span>)</span></span></code></pre>

<p>Finally get the state:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">agent-get <span class="special">*my-agent*</span> #'<a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_168.html#IDX488" class="symbol">identity</a></span>)</span></span></code></pre>

<p>This <code>agent-get</code> just uses the <code>identity</code> function to return the state
as is.</p>

<p>So this simple agent represents a counter.</p>

<p>It is important to note that the retrieves state, i.e. with <code>identity</code>
should not be modified outside the agent.</p>

<h4>Using an agent within an actor-system</h4>

<p>The <code>make-agent</code> constructor function allows to provides an optional
<code>system</code> argument that, when given, makes the constructor create the
agent within the given actor-system. This implies that the systems
shared messages dispatcher is used for the agent and no separate thread
is created for the agents message box.</p>

<p>It also implies that the agent is destroyed then the actor-system is
destroyed.</p>

<p>However, while actors can create hierarchies, agents can not. Also the
API for creating agents in systems is different to actors. This is to
make explicit that agents are treated slightly differently than actors
even though under the hood agents are actors.</p>

<h4>Wrapping an agent</h4>

<p>While you can use the agent as in the example above it is usually
advised to wrap an agent behind a more simple facade that doesn't work
with lambdas.</p>

<p>For example could a facade for the counter above look like this:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_143.html#IDX430" class="symbol"><i><span class="symbol">defvar</span></i></a> <span class="special">*counter-agent*</span> <a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_6.html#SEC6" class="symbol">nil</a></span>)</span>

<span class="paren1">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_167.html#IDX483" class="symbol"><i><span class="symbol">defun</span></i></a> init-agent <span class="paren2">(<span class="code">initial-value</span>)</span>
  <span class="paren2">(<span class="code">setf <span class="special">*counter-agent*</span> <span class="paren3">(<span class="code">make-agent <span class="paren4">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_330.html#IDX1006" class="symbol"><i><span class="symbol">lambda</span></i></a> <span class="paren5">(<span class="code"></span>)</span> initial-value</span>)</span></span>)</span></span>)</span></span>)</span>

<span class="paren1">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_167.html#IDX483" class="symbol"><i><span class="symbol">defun</span></i></a> increment <span class="paren2">(<span class="code"></span>)</span> <span class="paren2">(<span class="code">agent-update <span class="special">*counter-agent*</span> #'<a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_63.html#IDX103" class="symbol">1+</a></span>)</span></span>)</span>
<span class="paren1">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_167.html#IDX483" class="symbol"><i><span class="symbol">defun</span></i></a> decrement <span class="paren2">(<span class="code"></span>)</span> <span class="paren2">(<span class="code">agent-update <span class="special">*counter-agent*</span> #'<a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_63.html#IDX104" class="symbol">1-</a></span>)</span></span>)</span>
<span class="paren1">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_167.html#IDX483" class="symbol"><i><span class="symbol">defun</span></i></a> counter-value <span class="paren2">(<span class="code"></span>)</span> <span class="paren2">(<span class="code">agent-get <span class="special">*counter-agent*</span> #'<a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_168.html#IDX488" class="symbol">identity</a></span>)</span></span>)</span></span></code></pre>

<p>Alternatively, one can wrap an agent inside a class and provide methods
for simplified access to it.</p>

<h3>Router</h3>

<p>A <code>Router</code> is a facade over a set of actors. Routers are
either created with a set of actors using the default constructor
<code>router:make-router</code> or actors can be added later.</p>

<p>Routers implement part of the actor protocol, so it allows to use
<code>tell</code>, <code>ask-s</code> or <code>ask</code> which it
forwards to a 'routee' (one of the actors of a router) by passing all
of the given parameters. The routee is chosen by applying a
<code>strategy</code>. The built-in default strategy a routee is chosen
randomly.</p>

<p>The <code>strategy</code> can be configured when creating a router using
the constructors <code>&amp;key</code> parameter <code>:strategy</code>. The
<code>strategy</code> is just a function that takes the number of
routees and returns a routee index to be chosen for the next operation.</p>

<p>Currently available strategies: <code>:random</code> and
<code>:round-robin</code>.</p>

<p>Custom strategies can be implemented.</p>

<h3>Dispatchers</h3>

<h4>:shared</h4>

<p>A <code>:shared</code> dispatcher is a separate facility that is set up in the <code>actor-system</code>. It consists of a configurable pool of 'dispatcher workers' (which are in fact actors). Those dispatcher workers execute the message handling in behalf of the actor and with the actors message handling code. This is protected by a lock so that ever only one dispatcher will run code on an actor. This is to ensure protection from data race conditions of the state data of the actor (or other slots of the actor).</p>

<p>Using this dispatcher allows to create a large number of actors. The actors as such are generally very cheap.</p>

<p><img alt="" src="./docs/disp_shared.png" width="700"/>
<img alt="" src="disp_shared.png" width="700"/></p>

<h4>:pinned</h4>

<p>The <code>:pinned</code> dispatcher is represented by a thread that operates on the actors message queue. It handles one message after the other with the actors message handling code. This also ensures protection from data race conditions of the state of the actor.</p>

<p>This variant is slightly faster (see below) but requires one thread per actor.</p>

<p><img alt="" src="./docs/disp_pinned.png" width="700"/>
<img alt="" src="disp_pinned.png" width="700"/></p>

<h4>custom dispatcher</h4>

<p>It is also possible to create additional dispatcher of type <code>:shared</code>. A name can be freely chosen, but by convention it should be a global symbol, i.e. <code>:my-dispatcher</code>.</p>

<p>When creating actors using <code>act:actor-of</code>, or when using the <code>tasks</code> api it is possible to specify the dispatcher (via the 'dispatcher-id' i.e. <code>:my-dispatcher</code>) that should handle the actor, agent, or task messages.</p>

<p>A custom dispatcher is in particular useful when using <code>tasks</code> for longer running operations. Longer running operations should not be used for the <code>:shared</code> dispatcher because it (by default) is responsible for the message handling of most actors.</p>

<h3>Eventstream</h3>

<p>The eventstream allows messages (or events) to be posted on the eventstream in a fire-and-forget kind of way. Actors can subscribe to the eventstream if they want to get notified for particular messages or generally on all messages posted.<br/>
This allows to create event-based systems.</p>

<p>Here is a simple example:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defparameter</span></i> <span class="special">*sys*</span> <span class="paren2">(<span class="code">asys:make-actor-system</span>)</span></span>)</span>

<span class="paren1">(<span class="code">ac:actor-of <span class="special">*sys*</span> <span class="keyword">:name</span> <span class="string">"listener"</span>
  <span class="keyword">:init</span> <span class="paren2">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_330.html#IDX1006" class="symbol"><i><span class="symbol">lambda</span></i></a> <span class="paren3">(<span class="code">self</span>)</span>
          <span class="paren3">(<span class="code">ev:subscribe self self '<a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_71.html#IDX149" class="symbol">string</a></span>)</span></span>)</span>
  <span class="keyword">:receive</span> <span class="paren2">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_330.html#IDX1006" class="symbol"><i><span class="symbol">lambda</span></i></a> <span class="paren3">(<span class="code">self msg state</span>)</span>
             <span class="paren3">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_126.html#IDX389" class="symbol"><i><span class="symbol">cond</span></i></a>
               <span class="paren4">(<span class="code"><span class="paren5">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_73.html#IDX157" class="symbol">string=</a> <span class="string">"my-message"</span> msg</span>)</span>
                <span class="paren5">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_75.html#IDX176" class="symbol">format</a> <a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_266.html#IDX704" class="symbol">t</a> <span class="string">"received event: ~a~%"</span> msg</span>)</span></span>)</span></span>)</span>
             <span class="paren3">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_83.html#IDX221" class="symbol">cons</a> <span class="keyword">:no-reply</span> state</span>)</span></span>)</span></span>)</span>

<span class="paren1">(<span class="code">ev:publish <span class="special">*sys*</span> <span class="string">"my-message"</span></span>)</span></span></code></pre>

<p>This subscribes to all <code>'string</code> based events and just prints the message when received.<br/>
The subscription here is done using the <code>:init</code> hook of the actor. The <code>ev:subscribe</code> function requires to specify the eventstream as first argument. But there are different variants of the generic function defined which allows to specofy an actor directly. The eventstream is retrieve from the actor through its actor-context.</p>

<pre><code><span class="code">received event: my-message</span></code></pre>

<p>See the <a href="https://mdbergmann.github.io/cl-gserver/index.html#toc-2-7-eventstream" >API documentation</a> for more details.</p>

<h3>Tasks</h3>

<p>'tasks' is a convenience package that makes dealing with asynchronous and concurrent operations very easy.</p>

<p>Here is a simple example:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defparameter</span></i> <span class="special">*sys*</span> <span class="paren2">(<span class="code">make-actor-system</span>)</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">with-context</span></i> <span class="paren2">(<span class="code"><span class="special">*sys*</span></span>)</span>
  
  // run something without requiring a feedback
  <span class="paren2">(<span class="code">task-start <span class="paren3">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_330.html#IDX1006" class="symbol"><i><span class="symbol">lambda</span></i></a> <span class="paren4">(<span class="code"></span>)</span> <span class="paren4">(<span class="code">do-lengthy-IO</span>)</span></span>)</span>
  
  // run asynchronous <a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_63.html#IDX106" class="symbol">-</a> with await
  <span class="paren3">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_141.html#IDX422" class="symbol"><i><span class="symbol">let</span></i></a> <span class="paren4">(<span class="code"><span class="paren5">(<span class="code">task <span class="paren6">(<span class="code">task-async <span class="paren1">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_330.html#IDX1006" class="symbol"><i><span class="symbol">lambda</span></i></a> <span class="paren2">(<span class="code"></span>)</span> <span class="paren2">(<span class="code">do-a-task</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>
    // do some other stuff
    // eventually we need <i><span class="symbol">the</span></i> task result
    <span class="paren4">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_63.html#IDX105" class="symbol">+</a> <span class="paren5">(<span class="code">task-await task</span>)</span> 5</span>)</span></span>)</span>
    
  // run asynchronous with completion-handler <span class="paren3">(<span class="code">continuation</span>)</span>
  <span class="paren3">(<span class="code">task-async <span class="paren4">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_330.html#IDX1006" class="symbol"><i><span class="symbol">lambda</span></i></a> <span class="paren5">(<span class="code"></span>)</span> <span class="paren5">(<span class="code">some-bigger-computation</span>)</span></span>)</span>
              <span class="keyword">:on-complete-fun</span>
              <span class="paren4">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_330.html#IDX1006" class="symbol"><i><span class="symbol">lambda</span></i></a> <span class="paren5">(<span class="code">result</span>)</span>
                <span class="paren5">(<span class="code">do-something-with result</span>)</span></span>)</span></span>)</span>

  // concurrently map over <i><span class="symbol">the</span></i> given <a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_83.html#IDX225" class="symbol">list</a>
  <span class="paren3">(<span class="code">-&gt;&gt; 
    '<span class="paren4">(<span class="code">1 2 3 4 5</span>)</span>
    <span class="paren4">(<span class="code">task-async-stream #'<a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_63.html#IDX103" class="symbol">1+</a></span>)</span>
    <span class="paren4">(<span class="code">reduce #'<a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_63.html#IDX105" class="symbol">+</a></span>)</span></span>)</span></span>)</span>

=&gt; 20 <span class="paren2">(<span class="code">5 bits, #x14, #o24, #b10100</span>)</span>
</span></span></span></code></pre>

<p>All functions available in 'tasks' package require to be wrapped in a <code>with-context</code> macro. This macro removes the necessity of an additional argument to each of the functions which is instead supplied by the macro.</p>

<p>What happens in this example is that the list <code>'(1 2 3 4 5)</code> is passed to <code>task-async-stream</code>.
<code>task-async-stream</code> then spawns a 'task' for each element of the list and applies the given function (here <code>1+</code>) on each list element. The function though is executed by a worker of the actor-systems <code>:shared</code> dispatcher. <code>task-async-stream</code> then also collects the result of all workers. In the last step (<code>reduce</code>) the sum of the elements of the result list are calculated.</p>

<p>It is possible to specify a second argument to the <code>with-context</code> macro to specify the dispatcher that should be used for the tasks.<br/>
The concurrency here depends on the number of dispatcher workers.</p>

<p>As alternative, or in special circumstances, it is also possible to setf <code>*task-context*</code> and <code>*task-dispatcher*</code> special variables which allows to use <strong>tasks</strong> without <code>with-context</code> macro.</p>

<p>Be also aware that the <code>:shared</code> dispatcher should not run long running operations as it blocks a message processing thread. Create a custom dispatcher to use for <code>tasks</code> when you plan to operate longer running operations.</p>

<p>See the <a href="https://mdbergmann.github.io/cl-gserver/index.html#toc-2-8-tasks" >API documentation</a> for more details.</p>

<h3>Immutability</h3>

<p>Some words on immutability. sento does <em>not</em> make deep copies of the actor states. So whatever is returned from <code>receive</code> function as part of the <code>(cons back-msg state)</code> is just <code>setf</code>ed to the actor state. The user is responsible to make deep copies if necessary in an immutable environment. The user is responsible to <em>not</em> implictly modify the actor state outside of the actor.</p>

<h3>Logging</h3>

<p>sento does its own logging using different log levels from 'trace' to 'error'. It uses log4cl. If you wish to also use log4cl in your application but find that sento is too noisy in debug and trace logging you can change the log level for the 'sento package only by:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">log:config '<span class="paren2">(<span class="code">sento</span>)</span> <span class="keyword">:warn</span></span>)</span></span></code></pre>

<p>This will tell log4cl to do any logging for sento in warn level.</p>

<h3>Benchmarks</h3>

<p><img src="./docs/perf.png" alt="" />
<img src="perf.png" alt="" /></p>

<p>Hardware specs:</p>

<ul>
<li>iMac Pro (2017) with 8 Core Xeon, 32 GB RAM</li>
</ul>

<p><strong>All</strong></p>

<p>The benchmark was created by having 8 threads throwing each 125k (1m
alltogether) messages at 1 actor. The timing was taken for when the
actor did finish processing those 1m messages. The messages were sent by
either all <code>tell</code>, <code>ask-s</code>, or <code>ask</code> to
an actor whose message-box worked using a single thread
(<code>:pinned</code>) or a dispatched message queue
(<code>:shared</code> / <code>dispatched</code>) with 8 workers.</p>

<p>Of course a <code>tell</code> is in most cases the fastest one, because
it's the least resource intensive and there is no place that is
blocking in this workflow.</p>

<p><strong>SBCL (v2.0.10)</strong></p>

<p>Even though SBCL is by far the fastest one with <code>tell</code> on
both <code>:pinned</code> and <code>dispatched</code>, it had massive
problems on <code>dispatched - ask-s</code> where I had to lower the
number of messages to 200k alltogether. Beyond that value SBCL didn't
get it worked out.</p>

<p><strong>LispWorks (8.0)</strong></p>

<p>LispWorks is fast overall. Not as fast as SBCL. But it seems the GC is more robust, in particular on the <code>dispatched - ask</code>.</p>

<p><strong>CCL (v1.12)</strong></p>

<p>CCL is on acceptable average speed. The problems CCL had was heap
exhaustion for both the <code>ask</code> tasks where the number of
messages had to be reduced to 80k. Which is not a lot. Beyond this value
the runtime would crash. However, CCL for some reason had no problems
where SBCL was struggling with the <code>dispatched - ask-s</code>.</p>

<p><strong>ABCL (1.8)</strong></p>

<p>The pleasant surprise was ABCL. While not being the fastest it is the
most robust. Where SBCL and CCL were struggling you could throw anything
at ABCL and it'll cope with it. I'm assuming that this is because of
the massively battle proven Java Runtime.</p>

<p><a id="x-28SENTO-2EDOCS-3A-40API-20MGL-PAX-3ASECTION-29"></a>
<a id="SENTO.DOCS:@API%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#SENTO.DOCS:@README%20MGL-PAX:SECTION" title="Introduction">&#8592;</a> <a href="#SENTO.DOCS:@SENTO%20MGL-PAX:SECTION" title="sento documentation">&#8593;</a> <a href="#SENTO.ACTOR-SYSTEM:@ACTOR-SYSTEM%20MGL-PAX:SECTION" title="Actor-System">&#8594;</a> <a href="#SENTO.DOCS:@API%20MGL-PAX:SECTION" title="API documentation">&#8634;</a></span></span></p>

<h2><a href="#SENTO.DOCS:@API%20MGL-PAX:SECTION">2 API documentation</a></h2>

<p><a id="x-28SENTO-2EACTOR-SYSTEM-3A-40ACTOR-SYSTEM-20MGL-PAX-3ASECTION-29"></a>
<a id="SENTO.ACTOR-SYSTEM:@ACTOR-SYSTEM%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#SENTO.DOCS:@API%20MGL-PAX:SECTION" title="API documentation">&#8592;</a> <a href="#SENTO.DOCS:@API%20MGL-PAX:SECTION" title="API documentation">&#8593;</a> <a href="#SENTO.ACTOR-CONTEXT:@ACTOR-CONTEXT%20MGL-PAX:SECTION" title="Actor-Context">&#8594;</a> <a href="#SENTO.ACTOR-SYSTEM:@ACTOR-SYSTEM%20MGL-PAX:SECTION" title="Actor-System">&#8634;</a></span></span></p>

<h3><a href="#SENTO.ACTOR-SYSTEM:@ACTOR-SYSTEM%20MGL-PAX:SECTION">2.1 Actor-System</a></h3>

<h6>[in package SENTO.ACTOR-SYSTEM with nicknames ASYS]</h6>

<p><a id="x-28SENTO-2EACTOR-SYSTEM-3AACTOR-SYSTEM-20CLASS-29"></a>
<a id="SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[class]</span> <span class="reference-object"><a href="#SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%20CLASS" >ACTOR-SYSTEM</a></span></span></span></p>

<p>An <code>actor-system</code> is the opening facility. The first thing you do is to create an <code>actor-system</code> using the main constructor <a href="#SENTO.ACTOR-SYSTEM:MAKE-ACTOR-SYSTEM%20FUNCTION" title="SENTO.ACTOR-SYSTEM:MAKE-ACTOR-SYSTEM FUNCTION"><code>make-actor-system</code></a>.
With the <code>actor-system</code> you can create actors via the <a href="#SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT%20CLASS" title="SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT CLASS"><code>ac:actor-context</code></a> protocol function: <a href="#SENTO.ACTOR-CONTEXT:ACTOR-OF%20GENERIC-FUNCTION" title="SENTO.ACTOR-CONTEXT:ACTOR-OF GENERIC-FUNCTION"><code>ac:actor-of</code></a>.</p>

<p>Or even simpler via <code>act:actor-of</code> which is a convenience macro:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">act:actor-of <span class="paren2">(<span class="code"><span class="special">*system*</span></span>)</span>
                <span class="paren2">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_330.html#IDX1006" class="symbol"><i><span class="symbol">lambda</span></i></a> <span class="paren3">(<span class="code">self msg state</span>)</span>
                  <span class="comment">;; do stuff
</span>                  <span class="paren3">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_83.html#IDX221" class="symbol">cons</a> <span class="string">"done"</span> state</span>)</span></span>)</span></span>)</span></span></code></pre></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-SYSTEM-3AMAKE-ACTOR-SYSTEM-20FUNCTION-29"></a>
<a id="SENTO.ACTOR-SYSTEM:MAKE-ACTOR-SYSTEM%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.ACTOR-SYSTEM:MAKE-ACTOR-SYSTEM%20FUNCTION" >MAKE-ACTOR-SYSTEM</a></span></span> <span class="locative-args">&amp;OPTIONAL CONFIG</span></span></p>

<p>Creates an <a href="#SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%20CLASS" title="SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM CLASS"><code>actor-system</code></a>.</p>

<p>Allows to provide an optional configuration. See <a href="#SENTO.ACTOR-SYSTEM:*DEFAULT-CONFIG*%20VARIABLE" title="SENTO.ACTOR-SYSTEM:*DEFAULT-CONFIG* VARIABLE"><code>asys:*default-config*</code></a>.
If no config is provided the default config is used.
Is a config provided then it is merged with the default config.
Config options in the existing config override the default config.
See <a href="#SENTO.CONFIG:CONFIG-FROM%20FUNCTION" title="SENTO.CONFIG:CONFIG-FROM FUNCTION"><code>config:config-from</code></a>.</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-SYSTEM-3A-2ADEFAULT-CONFIG-2A-20VARIABLE-29"></a>
<a id="SENTO.ACTOR-SYSTEM:*DEFAULT-CONFIG*%20VARIABLE"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[variable]</span> <span class="reference-object"><a href="#SENTO.ACTOR-SYSTEM:*DEFAULT-CONFIG*%20VARIABLE" >*DEFAULT-CONFIG*</a></span></span> <span class="locative-args">(:DISPATCHERS (:SHARED (:WORKERS 4 :STRATEGY :RANDOM)) :TIMEOUT-TIMER
 (:RESOLUTION 500 :MAX-SIZE 1000) :EVENTSTREAM (:DISPATCHER-ID :SHARED))</span></span></p>

<p>The default config used when creating an <a href="#SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%20CLASS" title="SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM CLASS"><code>asys:actor-system</code></a>.
The actor-system constructor allows to provide custom config options that override the default.</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-SYSTEM-3AREGISTER-DISPATCHER-20FUNCTION-29"></a>
<a id="SENTO.ACTOR-SYSTEM:REGISTER-DISPATCHER%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.ACTOR-SYSTEM:REGISTER-DISPATCHER%20FUNCTION" >REGISTER-DISPATCHER</a></span></span> <span class="locative-args">SYSTEM DISPATCHER</span></span></p>

<p>Registers a dispatcher to the actor-system.</p>

<ul>
<li><p><code>system</code>: the actor-system</p></li>
<li><p><code>dispatcher</code>: the dispatcher instance.</p></li>
</ul></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-SYSTEM-3AREGISTER-NEW-DISPATCHER-20FUNCTION-29"></a>
<a id="SENTO.ACTOR-SYSTEM:REGISTER-NEW-DISPATCHER%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.ACTOR-SYSTEM:REGISTER-NEW-DISPATCHER%20FUNCTION" >REGISTER-NEW-DISPATCHER</a></span></span> <span class="locative-args">SYSTEM DISPATCHER-ID &amp;KEY WORKERS STRATEGY</span></span></p>

<p>Makes and registers a new dispatcher.</p>

<ul>
<li><p><code>system</code>: the actor-system</p></li>
<li><p><code>dispatcher-id</code>: the dispatcher identifier. Usually a global symbol like <code>:foo</code></p></li>
<li><p><code>:workers</code>: key argument for the number of workers.</p></li>
<li><p><code>:strategy</code>: key argument for the dispatcher strategy (:random or :round-robin)</p></li>
</ul></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-SYSTEM-3AEVSTREAM-20-28MGL-PAX-3AREADER-20SENTO-2EACTOR-SYSTEM-3AACTOR-SYSTEM-29-29"></a>
<a id="SENTO.ACTOR-SYSTEM:EVSTREAM%20%28MGL-PAX:READER%20SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[reader]</span> <span class="reference-object"><a href="#SENTO.ACTOR-SYSTEM:EVSTREAM%20%28MGL-PAX:READER%20SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%29" >EVSTREAM</a></span></span> <span class="locative-args">ACTOR-SYSTEM (= NIL)</span></span></p>

<p>The system event stream. See <a href="#SENTO.EVENTSTREAM:EVENTSTREAM%20CLASS" title="SENTO.EVENTSTREAM:EVENTSTREAM CLASS"><code>ev:eventstream</code></a> for more info.</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CONTEXT-3AACTOR-OF-20-28METHOD-20NIL-20-28SENTO-2EACTOR-SYSTEM-3AACTOR-SYSTEM-29-29-29"></a>
<a id="SENTO.ACTOR-CONTEXT:ACTOR-OF%20%28METHOD%20NIL%20%28SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CONTEXT:ACTOR-OF%20%28METHOD%20NIL%20%28SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%29%29" >ACTOR-OF</a></span></span> <span class="locative-args">(SYSTEM ACTOR-SYSTEM)</span></span></p>

<p>See <code>ac:actor-of</code></p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CONTEXT-3AFIND-ACTORS-20-28METHOD-20NIL-20-28SENTO-2EACTOR-SYSTEM-3AACTOR-SYSTEM-20T-29-29-29"></a>
<a id="SENTO.ACTOR-CONTEXT:FIND-ACTORS%20%28METHOD%20NIL%20%28SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%20T%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CONTEXT:FIND-ACTORS%20%28METHOD%20NIL%20%28SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%20T%29%29" >FIND-ACTORS</a></span></span> <span class="locative-args">(SELF ACTOR-SYSTEM) PATH</span></span></p>

<p>See <code>ac:find-actors</code></p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CONTEXT-3AALL-ACTORS-20-28METHOD-20NIL-20-28SENTO-2EACTOR-SYSTEM-3AACTOR-SYSTEM-29-29-29"></a>
<a id="SENTO.ACTOR-CONTEXT:ALL-ACTORS%20%28METHOD%20NIL%20%28SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CONTEXT:ALL-ACTORS%20%28METHOD%20NIL%20%28SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%29%29" >ALL-ACTORS</a></span></span> <span class="locative-args">(SELF ACTOR-SYSTEM)</span></span></p>

<p>See <code>ac:all-actors</code></p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CONTEXT-3ASTOP-20-28METHOD-20NIL-20-28SENTO-2EACTOR-SYSTEM-3AACTOR-SYSTEM-20T-29-29-29"></a>
<a id="SENTO.ACTOR-CONTEXT:STOP%20%28METHOD%20NIL%20%28SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%20T%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CONTEXT:STOP%20%28METHOD%20NIL%20%28SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%20T%29%29" >STOP</a></span></span> <span class="locative-args">(SELF ACTOR-SYSTEM) ACTOR</span></span></p>

<p>See <code>ac:stop</code></p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CONTEXT-3ASHUTDOWN-20-28METHOD-20NIL-20-28SENTO-2EACTOR-SYSTEM-3AACTOR-SYSTEM-29-29-29"></a>
<a id="SENTO.ACTOR-CONTEXT:SHUTDOWN%20%28METHOD%20NIL%20%28SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CONTEXT:SHUTDOWN%20%28METHOD%20NIL%20%28SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%29%29" >SHUTDOWN</a></span></span> <span class="locative-args">(SELF ACTOR-SYSTEM)</span></span></p>

<p>See <code>ac:shutdown</code></p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CONTEXT-3A-40ACTOR-CONTEXT-20MGL-PAX-3ASECTION-29"></a>
<a id="SENTO.ACTOR-CONTEXT:@ACTOR-CONTEXT%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#SENTO.ACTOR-SYSTEM:@ACTOR-SYSTEM%20MGL-PAX:SECTION" title="Actor-System">&#8592;</a> <a href="#SENTO.DOCS:@API%20MGL-PAX:SECTION" title="API documentation">&#8593;</a> <a href="#SENTO.ACTOR-CONTEXT:@AC-PROTOCOL%20MGL-PAX:SECTION" title="Actor-Context protocol">&#8594;</a> <a href="#SENTO.ACTOR-CONTEXT:@ACTOR-CONTEXT%20MGL-PAX:SECTION" title="Actor-Context">&#8634;</a></span></span></p>

<h3><a href="#SENTO.ACTOR-CONTEXT:@ACTOR-CONTEXT%20MGL-PAX:SECTION">2.2 Actor-Context</a></h3>

<h6>[in package SENTO.ACTOR-CONTEXT with nicknames AC]</h6>

<p><a id="x-28SENTO-2EACTOR-CONTEXT-3AACTOR-CONTEXT-20CLASS-29"></a>
<a id="SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[class]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT%20CLASS" >ACTOR-CONTEXT</a></span></span></span></p>

<p><code>actor-context</code> deals with creating and maintaining actors.
The <code>actor-system</code> and the <code>actor</code> itself are composed of an <code>actor-context</code>.</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CONTEXT-3AMAKE-ACTOR-CONTEXT-20FUNCTION-29"></a>
<a id="SENTO.ACTOR-CONTEXT:MAKE-ACTOR-CONTEXT%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CONTEXT:MAKE-ACTOR-CONTEXT%20FUNCTION" >MAKE-ACTOR-CONTEXT</a></span></span> <span class="locative-args">ACTOR-SYSTEM &amp;OPTIONAL (ID <code>NIL</code>)</span></span></p>

<p>Creates an <a href="#SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT%20CLASS" title="SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT CLASS"><code>actor-context</code></a>. Requires a reference to <code>actor-system</code>
<code>id</code> is an optional value that can identify the <code>actor-context</code>.
Creating an actor-context manually is usually not needed.
An <a href="#SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%20CLASS" title="SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM CLASS"><code>asys:actor-system</code></a> implements the <code>actor-context</code> protocol.
An <a href="#SENTO.ACTOR:ACTOR%20CLASS" title="SENTO.ACTOR:ACTOR CLASS"><code>act:actor</code></a> contains an <code>actor-context</code>.</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CONTEXT-3AACTOR-OF-20-28METHOD-20NIL-20-28SENTO-2EACTOR-CONTEXT-3AACTOR-CONTEXT-29-29-29"></a>
<a id="SENTO.ACTOR-CONTEXT:ACTOR-OF%20%28METHOD%20NIL%20%28SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CONTEXT:ACTOR-OF%20%28METHOD%20NIL%20%28SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT%29%29" >ACTOR-OF</a></span></span> <span class="locative-args">(CONTEXT ACTOR-CONTEXT)</span></span></p>

<p>See <code>ac:actor-of</code>.</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CONTEXT-3AFIND-ACTORS-20-28METHOD-20NIL-20-28SENTO-2EACTOR-CONTEXT-3AACTOR-CONTEXT-20T-29-29-29"></a>
<a id="SENTO.ACTOR-CONTEXT:FIND-ACTORS%20%28METHOD%20NIL%20%28SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT%20T%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CONTEXT:FIND-ACTORS%20%28METHOD%20NIL%20%28SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT%20T%29%29" >FIND-ACTORS</a></span></span> <span class="locative-args">(CONTEXT ACTOR-CONTEXT) PATH</span></span></p>

<p>See <code>ac:find-actors</code></p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CONTEXT-3AALL-ACTORS-20-28METHOD-20NIL-20-28SENTO-2EACTOR-CONTEXT-3AACTOR-CONTEXT-29-29-29"></a>
<a id="SENTO.ACTOR-CONTEXT:ALL-ACTORS%20%28METHOD%20NIL%20%28SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CONTEXT:ALL-ACTORS%20%28METHOD%20NIL%20%28SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT%29%29" >ALL-ACTORS</a></span></span> <span class="locative-args">(CONTEXT ACTOR-CONTEXT)</span></span></p>

<p>See <code>ac:all-actors</code></p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CONTEXT-3ASTOP-20-28METHOD-20NIL-20-28SENTO-2EACTOR-CONTEXT-3AACTOR-CONTEXT-20T-29-29-29"></a>
<a id="SENTO.ACTOR-CONTEXT:STOP%20%28METHOD%20NIL%20%28SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT%20T%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CONTEXT:STOP%20%28METHOD%20NIL%20%28SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT%20T%29%29" >STOP</a></span></span> <span class="locative-args">(CONTEXT ACTOR-CONTEXT) ACTOR</span></span></p>

<p>See <code>ac:stop</code></p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CONTEXT-3ASHUTDOWN-20-28METHOD-20NIL-20-28SENTO-2EACTOR-CONTEXT-3AACTOR-CONTEXT-29-29-29"></a>
<a id="SENTO.ACTOR-CONTEXT:SHUTDOWN%20%28METHOD%20NIL%20%28SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CONTEXT:SHUTDOWN%20%28METHOD%20NIL%20%28SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT%29%29" >SHUTDOWN</a></span></span> <span class="locative-args">(CONTEXT ACTOR-CONTEXT)</span></span></p>

<p>See <code>ac:shutdown</code></p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CONTEXT-3ANOTIFY-20GENERIC-FUNCTION-29"></a>
<a id="SENTO.ACTOR-CONTEXT:NOTIFY%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CONTEXT:NOTIFY%20GENERIC-FUNCTION" >NOTIFY</a></span></span> <span class="locative-args">CONTEXT ACTOR NOTIFICATION</span></span></p>

<p>Notify the <a href="#SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT%20CLASS" title="SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT CLASS"><code>actor-context</code></a> about something that happened to an actor.
Current exists:</p>

<ul>
<li><code>:stopped</code>: this will remove the actor from the context.</li>
</ul></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CONTEXT-3ASYSTEM-20-28MGL-PAX-3AREADER-20SENTO-2EACTOR-CONTEXT-3AACTOR-CONTEXT-29-29"></a>
<a id="SENTO.ACTOR-CONTEXT:SYSTEM%20%28MGL-PAX:READER%20SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[reader]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CONTEXT:SYSTEM%20%28MGL-PAX:READER%20SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT%29" >SYSTEM</a></span></span> <span class="locative-args">ACTOR-CONTEXT (= NIL)</span></span></p>

<p>A reference to the <code>actor-system</code>.</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CONTEXT-3AID-20-28MGL-PAX-3AREADER-20SENTO-2EACTOR-CONTEXT-3AACTOR-CONTEXT-29-29"></a>
<a id="SENTO.ACTOR-CONTEXT:ID%20%28MGL-PAX:READER%20SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[reader]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CONTEXT:ID%20%28MGL-PAX:READER%20SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT%29" >ID</a></span></span> <span class="locative-args">ACTOR-CONTEXT (:ID = NIL)</span></span></p>

<p>The id of this actor-context. Usually a string.</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CONTEXT-3AACTOR-NAME-EXISTS-20CONDITION-29"></a>
<a id="SENTO.ACTOR-CONTEXT:ACTOR-NAME-EXISTS%20CONDITION"></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type">[condition]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CONTEXT:ACTOR-NAME-EXISTS%20CONDITION" >ACTOR-NAME-EXISTS</a></span></span> <span class="locative-args">ERROR</span></span></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CONTEXT-3A-40AC-PROTOCOL-20MGL-PAX-3ASECTION-29"></a>
<a id="SENTO.ACTOR-CONTEXT:@AC-PROTOCOL%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#SENTO.ACTOR-CONTEXT:@ACTOR-CONTEXT%20MGL-PAX:SECTION" title="Actor-Context">&#8592;</a> <a href="#SENTO.ACTOR-CONTEXT:@ACTOR-CONTEXT%20MGL-PAX:SECTION" title="Actor-Context">&#8593;</a> <a href="#SENTO.ACTOR:@ACTOR%20MGL-PAX:SECTION" title="Actor">&#8594;</a> <a href="#SENTO.ACTOR-CONTEXT:@AC-PROTOCOL%20MGL-PAX:SECTION" title="Actor-Context protocol">&#8634;</a></span></span></p>

<h4><a href="#SENTO.ACTOR-CONTEXT:@AC-PROTOCOL%20MGL-PAX:SECTION">2.2.1 Actor-Context protocol</a></h4>

<p><a id="x-28SENTO-2EACTOR-CONTEXT-3AACTOR-OF-20GENERIC-FUNCTION-29"></a>
<a id="SENTO.ACTOR-CONTEXT:ACTOR-OF%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CONTEXT:ACTOR-OF%20GENERIC-FUNCTION" >ACTOR-OF</a></span></span> <span class="locative-args">CONTEXT &amp;KEY RECEIVE INIT DESTROY DISPATCHER STATE TYPE NAME</span></span></p>

<p>Interface for creating an actor.</p>

<p><strong>!!! Attention:</strong> this factory function wraps the <a href="#SENTO.ACTOR:MAKE-ACTOR%20GENERIC-FUNCTION" title="SENTO.ACTOR:MAKE-ACTOR GENERIC-FUNCTION"><code>act:make-actor</code></a> functionality to something more simple to use. 
Using this function there is no need to use both <code>act:make-actor</code>.</p>

<p><code>context</code> is either an <a href="#SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%20CLASS" title="SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM CLASS"><code>asys:actor-system</code></a>, an <a href="#SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT%20CLASS" title="SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT CLASS"><code>ac:actor-context</code></a>, or an <a href="#SENTO.ACTOR:ACTOR%20CLASS" title="SENTO.ACTOR:ACTOR CLASS"><code>act:actor</code></a> (any type of actor).
The new actor is created in the given context.</p>

<ul>
<li><p><code>:receive</code> is required and must be a 3-arity lambda with arguments: 1. the actor, 2. the message, 3. the state
  Usually expressed as <code>(lambda (self msg state))</code>.</p></li>
<li><p><code>:init</code>: is an optional initialization function with one argument: the actor instance (self).
This represents a 'start' hook that is called after the actor was fully initialized.</p></li>
<li><p><code>:destroy</code>: is an optional destroy function also with the actor instance as argument.
This function allows to unsubsribe from event-stream or such.</p></li>
<li><p><code>:state</code> key can be used to initialize with a state.</p></li>
<li><p><code>:dispatcher</code> key can be used to define the message dispatcher manually.
  Options are <code>:shared</code> (default) and <code>:pinned</code>.</p></li>
<li><p><code>:type</code> can specify a custom actor class. See <code>act:make-actor</code> for more info.</p></li>
<li><p><code>:name</code> to set a specific name to the actor, otherwise a random name will be used.</p></li>
</ul></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CONTEXT-3AFIND-ACTORS-20GENERIC-FUNCTION-29"></a>
<a id="SENTO.ACTOR-CONTEXT:FIND-ACTORS%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CONTEXT:FIND-ACTORS%20GENERIC-FUNCTION" >FIND-ACTORS</a></span></span> <span class="locative-args">CONTEXT PATH &amp;KEY TEST KEY</span></span></p>

<p>Returns actors to be found by the criteria of:</p>

<ul>
<li><p><code>context</code>: an <a href="#SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT%20CLASS" title="SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT CLASS"><code>AC:ACTOR-CONTEXT</code></a>, or an <a href="#SENTO.ACTOR:ACTOR%20CLASS" title="SENTO.ACTOR:ACTOR CLASS"><code>ACT:ACTOR</code></a> or an <a href="#SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%20CLASS" title="SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM CLASS"><code>ASYS:ACTOR-SYSTEM</code></a> as all three implement <code>find-actors</code>.</p></li>
<li><p><code>path</code>: a path designator to be found. This can be just an actor name, like 'foo', then <code>find-actors</code> will only look in the given context for the actor. It can also be: 'foo/bar', a relative path, in whcih case <code>find-actors</code> will traverse the path (here 'bar' is a child of 'foo') to the last context and will try to find the actor by name there, 'bar' in this case. Also possible is a root path like '/user/foo/bar' which will start traversing contexts started from the root context, which is the actor-system.</p></li>
<li><p><code>test</code>: a 2-arity test function where the 1st argument is the <code>path</code>, the 2nd is the a result of the <code>key</code> function (which defaults to <a href="#SENTO.ACTOR-CELL:NAME%20%28MGL-PAX:READER%20SENTO.ACTOR-CELL:ACTOR-CELL%29" title="SENTO.ACTOR-CELL:NAME (MGL-PAX:READER SENTO.ACTOR-CELL:ACTOR-CELL)"><code>ACT-CELL:NAME</code></a>, so the name of the actor). The default function for <code>test</code> is <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_stgeq_.htm" title="STRING= FUNCTION"><code>STRING=</code></a>. However, in case of a multi-subpath <code>path</code> both <code>test</code> and <code>key</code> only apply to the last path component, which designates the actor name to be found.</p></li>
<li><p><code>key</code>: a 1-arie function applied on an actor instance. Defaults to <code>ACT-CELL:NAME</code>.</p></li>
</ul>

<p>Depending on <code>test</code> function the last path component can be used as a wildcard when using a <code>test</code> function like <code>STR:STARTS-WITH-P</code> or <code>STR:CONTAINSP</code> for example.</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CONTEXT-3AALL-ACTORS-20GENERIC-FUNCTION-29"></a>
<a id="SENTO.ACTOR-CONTEXT:ALL-ACTORS%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CONTEXT:ALL-ACTORS%20GENERIC-FUNCTION" >ALL-ACTORS</a></span></span> <span class="locative-args">CONTEXT</span></span></p>

<p>Retrieves all actors of this context as a list</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CONTEXT-3ASTOP-20GENERIC-FUNCTION-29"></a>
<a id="SENTO.ACTOR-CONTEXT:STOP%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CONTEXT:STOP%20GENERIC-FUNCTION" >STOP</a></span></span> <span class="locative-args">CONTEXT ACTOR &amp;KEY WAIT</span></span></p>

<p>Stops the given actor on the context. 
The context may either be an <a href="#SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT%20CLASS" title="SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT CLASS"><code>actor-context</code></a>, or an <code>actor-system</code>.
The actor is then also removed from the context.
Specify <code>wait</code> as <code>T</code> to block until the actor is stopped (default <code>NIL</code>).</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CONTEXT-3ASHUTDOWN-20GENERIC-FUNCTION-29"></a>
<a id="SENTO.ACTOR-CONTEXT:SHUTDOWN%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CONTEXT:SHUTDOWN%20GENERIC-FUNCTION" >SHUTDOWN</a></span></span> <span class="locative-args">CONTEXT &amp;KEY WAIT</span></span></p>

<p>Stops all actors in this context.
When the context is an <a href="#SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT%20CLASS" title="SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT CLASS"><code>actor-context</code></a> this still stop the actor context and all its actors.
For the <code>actor-system</code> it will stop the whole system with all actors.
Specify <code>wait</code> as <code>T</code> to block until all actors of the context are stopped (default <code>NIL</code>).</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-3A-40ACTOR-20MGL-PAX-3ASECTION-29"></a>
<a id="SENTO.ACTOR:@ACTOR%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#SENTO.ACTOR-CONTEXT:@AC-PROTOCOL%20MGL-PAX:SECTION" title="Actor-Context protocol">&#8592;</a> <a href="#SENTO.DOCS:@API%20MGL-PAX:SECTION" title="API documentation">&#8593;</a> <a href="#SENTO.ACTOR-CELL:@ACTOR-CELL%20MGL-PAX:SECTION" title="Actor-Cell">&#8594;</a> <a href="#SENTO.ACTOR:@ACTOR%20MGL-PAX:SECTION" title="Actor">&#8634;</a></span></span></p>

<h3><a href="#SENTO.ACTOR:@ACTOR%20MGL-PAX:SECTION">2.3 Actor</a></h3>

<h6>[in package SENTO.ACTOR with nicknames ACT]</h6>

<p><a id="x-28SENTO-2EACTOR-3AACTOR-20CLASS-29"></a>
<a id="SENTO.ACTOR:ACTOR%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[class]</span> <span class="reference-object"><a href="#SENTO.ACTOR:ACTOR%20CLASS" >ACTOR</a></span></span> <span class="locative-args"><a href="#SENTO.ACTOR-CELL:ACTOR-CELL%20CLASS" title="SENTO.ACTOR-CELL:ACTOR-CELL CLASS">ACTOR-CELL</a></span></span></p>

<p>This is the <a href="#SENTO.ACTOR:ACTOR%20CLASS" title="SENTO.ACTOR:ACTOR CLASS"><code>actor</code></a> class.</p>

<p>The <code>actor</code> does its message handling using the <code>receive</code> function.</p>

<p>The <code>receive</code> function has to return a <code>cons</code>(<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_cons.htm" title="CONS FUNCTION"><code>0</code></a> <a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_cons.htm" title="CONS TYPE"><code>1</code></a>) constructed of a message to be sent back to caller (<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_car_c.htm" title="CAR FUNCTION"><code>car</code></a>), if applicable, and the new state of the actor (as <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_car_c.htm" title="CDR FUNCTION"><code>cdr</code></a>).
I.e.: <code>(cons &lt;my-response&gt; &lt;my-new-state&gt;)</code></p>

<p>There is asynchronous <a href="#SENTO.ACTOR:TELL%20GENERIC-FUNCTION" title="SENTO.ACTOR:TELL GENERIC-FUNCTION"><code>tell</code></a> (no response), a synchronous <a href="#SENTO.ACTOR:ASK-S%20GENERIC-FUNCTION" title="SENTO.ACTOR:ASK-S GENERIC-FUNCTION"><code>ask-s</code></a> and asynchronous <a href="#SENTO.ACTOR:ASK%20GENERIC-FUNCTION" title="SENTO.ACTOR:ASK GENERIC-FUNCTION"><code>ask</code></a> which all can be used to send messages to the actor. The 'ask' variants provide a response from the actor where 'tell' is only fire-and-forget.</p>

<p>If the 'send' operation was <code>ask-s</code> or <code>ask</code> then the <code>car</code> part of the <code>cons</code> result will be sent back to the caller.
In case of a <code>tell</code> operation there will be no response and the <code>car</code> of the <code>cons</code> is ignored, if there is no sender (see <code>sender</code> argument to <code>tell</code>). If there is a sender defined (which must be an actor), then the <code>car</code> of the <code>cons</code> result is sent (using <code>tell</code>) to the sender.<br/>
It is possible to specify <code>:no-reply</code> as <code>car</code> of <code>cons</code> in this case (<code>tell</code> with sender), which has the effect that the result is <em>not</em> sent to the sender even if one exists. This is for the case that the user wants to handle the state and the notifications to a sender himself. It is useful when the message handling code for a particular message (in <code>receive</code>) should be executed in a special thread-pool, because long running operations within <code>receive</code> will block the message handling of the actor.</p>

<p>The <code>:no-reply</code> result works for <code>ask</code> and <code>tell</code>, because also <code>ask</code> is based on <code>tell</code>.
<code>ask-s</code> is really only useful if a synchronous result is required and should be avoided otherwise.</p>

<p>To stop an actors message processing in order to cleanup resouces you should <code>tell</code> (or <code>ask-s</code>) the <code>:stop</code> message. It will respond with <code>:stopped</code> (in case of <code>ask(-s)</code>).</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-3AMAKE-ACTOR-20GENERIC-FUNCTION-29"></a>
<a id="SENTO.ACTOR:MAKE-ACTOR%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#SENTO.ACTOR:MAKE-ACTOR%20GENERIC-FUNCTION" >MAKE-ACTOR</a></span></span> <span class="locative-args">RECEIVE &amp;KEY NAME STATE TYPE INIT DESTROY</span></span></p>

<p>Constructs an <a href="#SENTO.ACTOR:ACTOR%20CLASS" title="SENTO.ACTOR:ACTOR CLASS"><code>actor</code></a>.</p>

<p>Arguments:</p>

<ul>
<li><p><code>receive</code>: this is a function that must accept 3 parameters. That is:</p></li>
<li><p>the actor <code>instance</code> itself, </p></li>
<li><p>the <code>message</code> and </p></li>
<li><p>the <code>current-state</code> of the actor.</p></li>
<li><p><code>name</code>: give the actor a name. Must be unique within an <a href="#SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT%20CLASS" title="SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT CLASS"><code>ac:actor-context</code></a>.</p></li>
<li><p><code>type</code>: Specify a custom actor class as the <code>:type</code> key. Defaults to 'actor.
Say you have a custom actor <code>custom-actor</code> and want <code>make-actor</code> create an instance of it.
Then specify <code>:type 'custom-actor</code> on <code>make-actor</code> function.
If you have additional initializations to make you can do so in <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_init_i.htm" title="INITIALIZE-INSTANCE FUNCTION"><code>initialize-instance</code></a>.</p></li>
<li><p><code>state</code>: initialize an actor with a state. (default is <code>nil</code>)</p></li>
<li><p><code>init</code> and <code>destroy</code>: are functions that take one argument, the actor instance.
Those hooks are called on (after) initialization and (after) stop respectively.</p></li>
</ul></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-3ATELL-20GENERIC-FUNCTION-29"></a>
<a id="SENTO.ACTOR:TELL%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#SENTO.ACTOR:TELL%20GENERIC-FUNCTION" >TELL</a></span></span> <span class="locative-args">ACTOR MESSAGE &amp;OPTIONAL SENDER</span></span></p>

<p>Sends a message to the <code>actor</code>. <code>tell</code> is asynchronous. There is no result.
If a <code>sender</code> is specified a message result of the target actor of the <code>tell</code> will be sent back to the <code>sender</code></p>

<p>Generally <code>tell</code> does not expect a response. But a <code>sender</code> can be specified as optionl parameter to <code>tell</code>.
If a <code>sender</code> is specified, then the message handling behavior will send the <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_car_c.htm" title="CAR FUNCTION"><code>car</code></a> of the <code>cons</code>(<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_cons.htm" title="CONS FUNCTION"><code>0</code></a> <a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_cons.htm" title="CONS TYPE"><code>1</code></a>) result to the specified <code>sender</code>.</p>

<p>A <code>sender</code> can also be part of the message contract.</p>

<p><code>tell</code> can be used in two environments:</p>

<ol>
<li>outside an actor</li>
</ol>

<p>By default this sends a message as fire &amp; forget. Since this is not inside an actor, no actor can be inferred as <code>sender</code>. A <code>sender</code> can be defined as optional parameter as part of <code>tell</code>.</p>

<ol>
<li>inside an actors as part of the <code>receive</code> function</li>
</ol>

<p>As <code>sender</code> can be specified when <code>tell</code> is used inside of an actor. Currently the framework doesn't automatically infer the <code>sender</code> when no <code>sender</code> is explicitly specified.</p>

<p>=&gt; This is a future enhancement.</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-3AASK-S-20GENERIC-FUNCTION-29"></a>
<a id="SENTO.ACTOR:ASK-S%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#SENTO.ACTOR:ASK-S%20GENERIC-FUNCTION" >ASK-S</a></span></span> <span class="locative-args">ACTOR MESSAGE &amp;KEY TIME-OUT</span></span></p>

<p>Sends a message to the <code>actor</code>. <code>ask-s</code> is synchronous and waits for a result.
Specify <code>timeout</code> if a message is to be expected after a certain time.
An <code>:handler-error</code> with <code>timeout</code> condition will be returned if the call timed out.</p>

<p><code>ask-s</code> assumes, no matter if <code>ask-s</code> is issued from outside or inside an actor, that the response is delivered back to the caller. That's why <code>ask-s</code> does block the execution until the result is available. The <code>receive</code> function handler must specify the result as the <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_car_c.htm" title="CAR FUNCTION"><code>car</code></a> of the cons result.</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-3AASK-20GENERIC-FUNCTION-29"></a>
<a id="SENTO.ACTOR:ASK%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#SENTO.ACTOR:ASK%20GENERIC-FUNCTION" >ASK</a></span></span> <span class="locative-args">ACTOR MESSAGE &amp;KEY TIME-OUT</span></span></p>

<p>This returns a <code>future</code>.
Specify <code>timeout</code> if a message is to be expected after a certain time.
An <code>:handler-error</code> with <code>timeout</code> condition will be returned is the call timed out.</p>

<p>An <code>ask</code> is similar to a <a href="#SENTO.ACTOR:ASK-S%20GENERIC-FUNCTION" title="SENTO.ACTOR:ASK-S GENERIC-FUNCTION"><code>ask-s</code></a> in that the caller gets back a result 
but it doesn't have to actively wait for it. Instead a <code>future</code> wraps the result.
However, the internal message handling is based on <a href="#SENTO.ACTOR:TELL%20GENERIC-FUNCTION" title="SENTO.ACTOR:TELL GENERIC-FUNCTION"><code>tell</code></a>.
How this works is that the message to the target <code>actor</code> is not 'sent' using the callers thread
but instead an anonymous <code>actor</code> is started behind the scenes and this in fact makes tells
the message to the target <code>actor</code>. It does sent itself along as 'sender'.
The target <code>actor</code> tells a response back to the initial <code>sender</code>. When that happens and the anonymous <code>actor</code> received the response the <code>future</code> will be fulfilled with the <code>promise</code>.</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-3ABECOME-20GENERIC-FUNCTION-29"></a>
<a id="SENTO.ACTOR:BECOME%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#SENTO.ACTOR:BECOME%20GENERIC-FUNCTION" >BECOME</a></span></span> <span class="locative-args">ACTOR NEW-BEHAVIOR</span></span></p>

<p>Changes the receive of the actor to the given <code>new-behavior</code> function.
The <code>new-behavior</code> function must accept 3 parameters: the actor instance, the message and the current state.</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-3AUNBECOME-20GENERIC-FUNCTION-29"></a>
<a id="SENTO.ACTOR:UNBECOME%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#SENTO.ACTOR:UNBECOME%20GENERIC-FUNCTION" >UNBECOME</a></span></span> <span class="locative-args">ACTOR</span></span></p>

<p>Reverts any behavior applied via <a href="#SENTO.ACTOR:BECOME%20GENERIC-FUNCTION" title="SENTO.ACTOR:BECOME GENERIC-FUNCTION"><code>become</code></a> back to the default <code>receive</code> function.</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-3ACONTEXT-20GENERIC-FUNCTION-29"></a>
<a id="SENTO.ACTOR:CONTEXT%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#SENTO.ACTOR:CONTEXT%20GENERIC-FUNCTION" >CONTEXT</a></span></span> <span class="locative-args">ACTOR</span></span></p>

<p>This is the <code>actor-context</code> every actor is composed of.
When the actor is created from scratch it has no <code>actor-context</code>.
When created through the <code>actor-context</code>s, or system's <a href="#SENTO.ACTOR-CONTEXT:ACTOR-OF%20GENERIC-FUNCTION" title="SENTO.ACTOR-CONTEXT:ACTOR-OF GENERIC-FUNCTION"><code>actor-of</code></a> function an <code>actor-context</code> will be set.</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-3APATH-20GENERIC-FUNCTION-29"></a>
<a id="SENTO.ACTOR:PATH%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#SENTO.ACTOR:PATH%20GENERIC-FUNCTION" >PATH</a></span></span> <span class="locative-args">ACTOR</span></span></p>

<p>The path of the actor, including the actor itself.
The path denotes a tree which starts at the system context.</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-3AWATCH-20GENERIC-FUNCTION-29"></a>
<a id="SENTO.ACTOR:WATCH%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#SENTO.ACTOR:WATCH%20GENERIC-FUNCTION" >WATCH</a></span></span> <span class="locative-args">ACTOR WATCHER</span></span></p>

<p>Registers <code>watcher</code> as a watcher of <code>actor</code>.
Watching lets the watcher know about lifecycle changes of the actor being watched.
I.e.: when it stopped. The message being sent in this case is: <code>(cons :stopped actor-instance)</code></p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-3AUNWATCH-20GENERIC-FUNCTION-29"></a>
<a id="SENTO.ACTOR:UNWATCH%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#SENTO.ACTOR:UNWATCH%20GENERIC-FUNCTION" >UNWATCH</a></span></span> <span class="locative-args">ACTOR WATCHER</span></span></p>

<p>Unregisters <code>watcher</code> of <code>actor</code>.</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-3AWATCHERS-20GENERIC-FUNCTION-29"></a>
<a id="SENTO.ACTOR:WATCHERS%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#SENTO.ACTOR:WATCHERS%20GENERIC-FUNCTION" >WATCHERS</a></span></span> <span class="locative-args">ACTOR</span></span></p>

<p>Returns a list of watchers of <code>actor</code>.</p></li>
</ul>

<p><a id="x-28SENTO-2EEVENTSTREAM-3ASUBSCRIBE-20-28METHOD-20NIL-20-28SENTO-2EACTOR-3AACTOR-20SENTO-2EACTOR-3AACTOR-29-29-29"></a>
<a id="SENTO.EVENTSTREAM:SUBSCRIBE%20%28METHOD%20NIL%20%28SENTO.ACTOR:ACTOR%20SENTO.ACTOR:ACTOR%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#SENTO.EVENTSTREAM:SUBSCRIBE%20%28METHOD%20NIL%20%28SENTO.ACTOR:ACTOR%20SENTO.ACTOR:ACTOR%29%29" >SUBSCRIBE</a></span></span> <span class="locative-args">(ACTOR ACTOR) (SUBSCRIBER ACTOR)</span></span></p>

<p>Convenience. Allows to subscribe to <a href="#SENTO.EVENTSTREAM:EVENTSTREAM%20CLASS" title="SENTO.EVENTSTREAM:EVENTSTREAM CLASS"><code>ev:eventstream</code></a> by just providing the actor.</p></li>
</ul>

<p><a id="x-28SENTO-2EEVENTSTREAM-3AUNSUBSCRIBE-20-28METHOD-20NIL-20-28SENTO-2EACTOR-3AACTOR-20SENTO-2EACTOR-3AACTOR-29-29-29"></a>
<a id="SENTO.EVENTSTREAM:UNSUBSCRIBE%20%28METHOD%20NIL%20%28SENTO.ACTOR:ACTOR%20SENTO.ACTOR:ACTOR%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#SENTO.EVENTSTREAM:UNSUBSCRIBE%20%28METHOD%20NIL%20%28SENTO.ACTOR:ACTOR%20SENTO.ACTOR:ACTOR%29%29" >UNSUBSCRIBE</a></span></span> <span class="locative-args">(ACTOR ACTOR) (UNSUBSCRIBER ACTOR)</span></span></p>

<p>Convenience. Allows to unsubscribe to <a href="#SENTO.EVENTSTREAM:EVENTSTREAM%20CLASS" title="SENTO.EVENTSTREAM:EVENTSTREAM CLASS"><code>ev:eventstream</code></a> by just providing the actor.</p></li>
</ul>

<p><a id="x-28SENTO-2EEVENTSTREAM-3APUBLISH-20-28METHOD-20NIL-20-28SENTO-2EACTOR-3AACTOR-20T-29-29-29"></a>
<a id="SENTO.EVENTSTREAM:PUBLISH%20%28METHOD%20NIL%20%28SENTO.ACTOR:ACTOR%20T%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#SENTO.EVENTSTREAM:PUBLISH%20%28METHOD%20NIL%20%28SENTO.ACTOR:ACTOR%20T%29%29" >PUBLISH</a></span></span> <span class="locative-args">(ACTOR ACTOR) MESSAGE</span></span></p>

<p>Convenience. Allows to publish to <a href="#SENTO.EVENTSTREAM:EVENTSTREAM%20CLASS" title="SENTO.EVENTSTREAM:EVENTSTREAM CLASS"><code>ev:eventstream</code></a> by just providing the actor.</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CONTEXT-3AFIND-ACTORS-20-28METHOD-20NIL-20-28SENTO-2EACTOR-3AACTOR-20T-29-29-29"></a>
<a id="SENTO.ACTOR-CONTEXT:FIND-ACTORS%20%28METHOD%20NIL%20%28SENTO.ACTOR:ACTOR%20T%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CONTEXT:FIND-ACTORS%20%28METHOD%20NIL%20%28SENTO.ACTOR:ACTOR%20T%29%29" >FIND-ACTORS</a></span></span> <span class="locative-args">(ACTOR ACTOR) PATH</span></span></p>

<p><a href="#SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT%20CLASS" title="SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT CLASS"><code>ac:actor-context</code></a> protocol implementation.</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CONTEXT-3AALL-ACTORS-20-28METHOD-20NIL-20-28SENTO-2EACTOR-3AACTOR-29-29-29"></a>
<a id="SENTO.ACTOR-CONTEXT:ALL-ACTORS%20%28METHOD%20NIL%20%28SENTO.ACTOR:ACTOR%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CONTEXT:ALL-ACTORS%20%28METHOD%20NIL%20%28SENTO.ACTOR:ACTOR%29%29" >ALL-ACTORS</a></span></span> <span class="locative-args">(ACTOR ACTOR)</span></span></p>

<p><a href="#SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT%20CLASS" title="SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT CLASS"><code>ac:actor-context</code></a> protocol implementation.</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CONTEXT-3AACTOR-OF-20-28METHOD-20NIL-20-28SENTO-2EACTOR-3AACTOR-29-29-29"></a>
<a id="SENTO.ACTOR-CONTEXT:ACTOR-OF%20%28METHOD%20NIL%20%28SENTO.ACTOR:ACTOR%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CONTEXT:ACTOR-OF%20%28METHOD%20NIL%20%28SENTO.ACTOR:ACTOR%29%29" >ACTOR-OF</a></span></span> <span class="locative-args">(ACTOR ACTOR)</span></span></p>

<p><a href="#SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT%20CLASS" title="SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT CLASS"><code>ac:actor-context</code></a> protocol implementation</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CELL-3A-40ACTOR-CELL-20MGL-PAX-3ASECTION-29"></a>
<a id="SENTO.ACTOR-CELL:@ACTOR-CELL%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#SENTO.ACTOR:@ACTOR%20MGL-PAX:SECTION" title="Actor">&#8592;</a> <a href="#SENTO.ACTOR:@ACTOR%20MGL-PAX:SECTION" title="Actor">&#8593;</a> <a href="#SENTO.MESSAGEB:@MESSAGE-BOX-BASE%20MGL-PAX:SECTION" title="Message-box base class">&#8594;</a> <a href="#SENTO.ACTOR-CELL:@ACTOR-CELL%20MGL-PAX:SECTION" title="Actor-Cell">&#8634;</a></span></span></p>

<h4><a href="#SENTO.ACTOR-CELL:@ACTOR-CELL%20MGL-PAX:SECTION">2.3.1 Actor-Cell</a></h4>

<h6>[in package SENTO.ACTOR-CELL with nicknames ACT-CELL]</h6>

<p><a id="x-28SENTO-2EACTOR-CELL-3AACTOR-CELL-20CLASS-29"></a>
<a id="SENTO.ACTOR-CELL:ACTOR-CELL%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[class]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CELL:ACTOR-CELL%20CLASS" >ACTOR-CELL</a></span></span></span></p>

<p><code>actor-cell</code> is the base of the <code>actor</code>.
It is meant to encapsulate state, but also to execute async operations.
State can be changed by calling into the server via <a href="#SENTO.ACTOR-CELL:CALL%20FUNCTION" title="SENTO.ACTOR-CELL:CALL FUNCTION"><code>call</code></a> or <a href="#SENTO.ACTOR-CELL:CAST%20FUNCTION" title="SENTO.ACTOR-CELL:CAST FUNCTION"><code>cast</code></a>.
Where <code>call</code> is waiting for a result and <code>cast</code> does not.
For each <code>call</code> and <code>cast</code> handlers must be implemented by subclasses.</p>

<p>It uses a <code>message-box</code> to processes the received messages.
When the <code>actor</code>/<code>actor-cell</code> was created ad-hoc (out of the <code>actor-system</code>/<code>actor-context</code>),
it will not have a message-box and can't process messages.
When the <code>actor</code> is created through the <code>actor-system</code> or <code>actor-context</code>,
one can decide what kind of message-box/dispatcher should be used for the new <code>actor</code>.</p>

<p>See <code>actor-context</code> <code>actor-of</code> method for more information on this.</p>

<p>To stop an <code>actor</code> message handling and you can send the <code>:stop</code> message 
either via <code>call</code> (which will respond with <code>:stopped</code>) or <code>cast</code>.
This is to cleanup thread resources when the actor is not needed anymore.</p>

<p>Note: the <code>actor-cell</code> uses <code>call</code> and <code>cast</code> functions which translate to <code>ask-s</code> and <code>tell</code> on the <code>actor</code>.</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CELL-3ANAME-20-28MGL-PAX-3AREADER-20SENTO-2EACTOR-CELL-3AACTOR-CELL-29-29"></a>
<a id="SENTO.ACTOR-CELL:NAME%20%28MGL-PAX:READER%20SENTO.ACTOR-CELL:ACTOR-CELL%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[reader]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CELL:NAME%20%28MGL-PAX:READER%20SENTO.ACTOR-CELL:ACTOR-CELL%29" >NAME</a></span></span> <span class="locative-args">ACTOR-CELL (:NAME = (STRING (GENSYM &quot;actor-&quot;)))</span></span></p>

<p>The name of the actor/actor-cell. If no name is specified a default one is applied.</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CELL-3ASTATE-20-28MGL-PAX-3AREADER-20SENTO-2EACTOR-CELL-3AACTOR-CELL-29-29"></a>
<a id="SENTO.ACTOR-CELL:STATE%20%28MGL-PAX:READER%20SENTO.ACTOR-CELL:ACTOR-CELL%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[reader]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CELL:STATE%20%28MGL-PAX:READER%20SENTO.ACTOR-CELL:ACTOR-CELL%29" >STATE</a></span></span> <span class="locative-args">ACTOR-CELL (:STATE = NIL)</span></span></p>

<p>The encapsulated state.</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CELL-3AMSGBOX-20-28MGL-PAX-3AACCESSOR-20SENTO-2EACTOR-CELL-3AACTOR-CELL-29-29"></a>
<a id="SENTO.ACTOR-CELL:MSGBOX%20%28MGL-PAX:ACCESSOR%20SENTO.ACTOR-CELL:ACTOR-CELL%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[accessor]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CELL:MSGBOX%20%28MGL-PAX:ACCESSOR%20SENTO.ACTOR-CELL:ACTOR-CELL%29" >MSGBOX</a></span></span> <span class="locative-args">ACTOR-CELL (= NIL)</span></span></p>

<p>The <code>message-box</code>. By default the <code>actor</code>/<a href="#SENTO.ACTOR-CELL:ACTOR-CELL%20CLASS" title="SENTO.ACTOR-CELL:ACTOR-CELL CLASS"><code>actor-cell</code></a> has no message-box.
When the actor is created through the <code>actor-context</code> of an actor, or the <code>actor-system</code>
then it will be populated with a message-box.</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CELL-3A-2ASENDER-2A-20VARIABLE-29"></a>
<a id="SENTO.ACTOR-CELL:*SENDER*%20VARIABLE"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[variable]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CELL:*SENDER*%20VARIABLE" >*SENDER*</a></span></span> <span class="locative-args">NIL</span></span></p>

<p>The <code>*sender*</code> is dynamically bound and available in <code>receive</code> function, when it is known.</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CELL-3AHANDLE-CALL-20GENERIC-FUNCTION-29"></a>
<a id="SENTO.ACTOR-CELL:HANDLE-CALL%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CELL:HANDLE-CALL%20GENERIC-FUNCTION" >HANDLE-CALL</a></span></span> <span class="locative-args">ACTOR-CELL MESSAGE CURRENT-STATE</span></span></p>

<p>Handles calls to the server. Must be implemented by subclasses.
The convention here is to return a <code>cons</code>(<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_cons.htm" title="CONS FUNCTION"><code>0</code></a> <a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_cons.htm" title="CONS TYPE"><code>1</code></a>) with values to be returned to caller as <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_car_c.htm" title="CAR FUNCTION"><code>car</code></a>, and the new state as <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_car_c.htm" title="CDR FUNCTION"><code>cdr</code></a>.
<code>handle-call</code> is executed in the default message dispatcher thread.</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CELL-3AHANDLE-CAST-20GENERIC-FUNCTION-29"></a>
<a id="SENTO.ACTOR-CELL:HANDLE-CAST%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CELL:HANDLE-CAST%20GENERIC-FUNCTION" >HANDLE-CAST</a></span></span> <span class="locative-args">ACTOR-CELL MESSAGE CURRENT-STATE</span></span></p>

<p>Handles casts to the server. Must be implemented by subclasses.
Same convention as for 'handle-call' except that no return is sent to the caller. This function returns immediately.</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CELL-3APRE-START-20GENERIC-FUNCTION-29"></a>
<a id="SENTO.ACTOR-CELL:PRE-START%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CELL:PRE-START%20GENERIC-FUNCTION" >PRE-START</a></span></span> <span class="locative-args">ACTOR-CELL STATE</span></span></p>

<p>Generic function definition that called from <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_init_i.htm" title="INITIALIZE-INSTANCE FUNCTION"><code>initialize-instance</code></a>.</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CELL-3AAFTER-STOP-20GENERIC-FUNCTION-29"></a>
<a id="SENTO.ACTOR-CELL:AFTER-STOP%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CELL:AFTER-STOP%20GENERIC-FUNCTION" >AFTER-STOP</a></span></span> <span class="locative-args">ACTOR-CELL</span></span></p>

<p>Generic function definition that is called after the actor cell has stopped.</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CELL-3ASTOP-20GENERIC-FUNCTION-29"></a>
<a id="SENTO.ACTOR-CELL:STOP%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CELL:STOP%20GENERIC-FUNCTION" >STOP</a></span></span> <span class="locative-args">ACTOR-CELL &amp;OPTIONAL WAIT</span></span></p>

<p>Stops the actor-cells message processing gracefully.
This is not an immediate stop.<br/>
There are two ways to stop an actor (cell).</p>

<ol>
<li><p>by calling this function.
It is not an immediate stop.
<code>wait</code>: waits until the cell is stopped.</p></li>
<li><p>by sending <code>:stop</code> to the actor (cell).
This won't allow to wait when the actor is stopped, even not with <code>ask-s</code>.</p></li>
</ol></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CELL-3ACALL-20FUNCTION-29"></a>
<a id="SENTO.ACTOR-CELL:CALL%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CELL:CALL%20FUNCTION" >CALL</a></span></span> <span class="locative-args">ACTOR-CELL MESSAGE &amp;KEY (TIME-OUT <code>NIL</code>)</span></span></p>

<p>Send a message to a actor-cell instance and wait for a result.
Specify a timeout in seconds if you require a result within a certain period of time.
Be aware though that this is a resource intensive wait based on a waiting thread.
The result can be of different types.
Success result: <returned-state>
Unhandled result: <code>:unhandled</code>
Error result: `(cons :handler-error <condition>)'
In case of time-out the error condition is a bt:timeout.</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CELL-3ACAST-20FUNCTION-29"></a>
<a id="SENTO.ACTOR-CELL:CAST%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CELL:CAST%20FUNCTION" >CAST</a></span></span> <span class="locative-args">ACTOR-CELL MESSAGE &amp;OPTIONAL SENDER</span></span></p>

<p>Sends a message to a actor-cell asynchronously. There is no result.
If a `sender' is specified the result will be sent to the sender.</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-CELL-3ARUNNING-P-20FUNCTION-29"></a>
<a id="SENTO.ACTOR-CELL:RUNNING-P%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.ACTOR-CELL:RUNNING-P%20FUNCTION" >RUNNING-P</a></span></span> <span class="locative-args">ACTOR-CELL</span></span></p>

<p>Returns true if this server is running. <code>nil</code> otherwise.</p></li>
</ul>

<p><a id="x-28SENTO-2EMESSAGEB-3A-40MESSAGE-BOX-BASE-20MGL-PAX-3ASECTION-29"></a>
<a id="SENTO.MESSAGEB:@MESSAGE-BOX-BASE%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#SENTO.ACTOR-CELL:@ACTOR-CELL%20MGL-PAX:SECTION" title="Actor-Cell">&#8592;</a> <a href="#SENTO.ACTOR:@ACTOR%20MGL-PAX:SECTION" title="Actor">&#8593;</a> <a href="#SENTO.MESSAGEB:@MESSAGE-BOX%2FBT%20MGL-PAX:SECTION" title="Message-box threaded">&#8594;</a> <a href="#SENTO.MESSAGEB:@MESSAGE-BOX-BASE%20MGL-PAX:SECTION" title="Message-box base class">&#8634;</a></span></span></p>

<h4><a href="#SENTO.MESSAGEB:@MESSAGE-BOX-BASE%20MGL-PAX:SECTION">2.3.2 Message-box base class</a></h4>

<h6>[in package SENTO.MESSAGEB with nicknames MESGB]</h6>

<p><a id="x-28SENTO-2EMESSAGEB-3AMESSAGE-BOX-BASE-20CLASS-29"></a>
<a id="SENTO.MESSAGEB:MESSAGE-BOX-BASE%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[class]</span> <span class="reference-object"><a href="#SENTO.MESSAGEB:MESSAGE-BOX-BASE%20CLASS" >MESSAGE-BOX-BASE</a></span></span></span></p>

<p>The user does not need to create a message-box manually. It is automatically created and added to the <code>actor</code> when the actor is created through <code>act:actor-of</code> or <a href="#SENTO.ACTOR-CONTEXT:ACTOR-OF%20GENERIC-FUNCTION" title="SENTO.ACTOR-CONTEXT:ACTOR-OF GENERIC-FUNCTION"><code>ac:actor-of</code></a>.</p></li>
</ul>

<p><a id="x-28SENTO-2EMESSAGEB-3ANAME-20-28MGL-PAX-3AREADER-20SENTO-2EMESSAGEB-3AMESSAGE-BOX-BASE-29-29"></a>
<a id="SENTO.MESSAGEB:NAME%20%28MGL-PAX:READER%20SENTO.MESSAGEB:MESSAGE-BOX-BASE%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[reader]</span> <span class="reference-object"><a href="#SENTO.MESSAGEB:NAME%20%28MGL-PAX:READER%20SENTO.MESSAGEB:MESSAGE-BOX-BASE%29" >NAME</a></span></span> <span class="locative-args">MESSAGE-BOX-BASE (:NAME = (STRING (GENSYM &quot;mesgb-&quot;)))</span></span></p>

<p>The name of the message-box.
The default name is concatenated of &quot;mesgb-&quot; and a <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_gensym.htm" title="GENSYM FUNCTION"><code>gensym</code></a> generated random number.</p></li>
</ul>

<p><a id="x-28SENTO-2EMESSAGEB-3AMAX-QUEUE-SIZE-20-28MGL-PAX-3AREADER-20SENTO-2EMESSAGEB-3AMESSAGE-BOX-BASE-29-29"></a>
<a id="SENTO.MESSAGEB:MAX-QUEUE-SIZE%20%28MGL-PAX:READER%20SENTO.MESSAGEB:MESSAGE-BOX-BASE%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[reader]</span> <span class="reference-object"><a href="#SENTO.MESSAGEB:MAX-QUEUE-SIZE%20%28MGL-PAX:READER%20SENTO.MESSAGEB:MESSAGE-BOX-BASE%29" >MAX-QUEUE-SIZE</a></span></span> <span class="locative-args">MESSAGE-BOX-BASE (:MAX-QUEUE-SIZE = 0)</span></span></p>

<p>0 or nil will make an unbounded queue. 
A value <code>&gt; 0</code> will make a bounded queue.
Don't make it too small. A queue size of 1000 might be a good choice.</p></li>
</ul>

<p><a id="x-28SENTO-2EMESSAGEB-3ASUBMIT-20GENERIC-FUNCTION-29"></a>
<a id="SENTO.MESSAGEB:SUBMIT%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#SENTO.MESSAGEB:SUBMIT%20GENERIC-FUNCTION" >SUBMIT</a></span></span> <span class="locative-args">MESSAGE-BOX-BASE MESSAGE WITHREPLY-P TIME-OUT HANDLER-FUN</span></span></p>

<p>Submit a message to the mailbox to be queued and handled.</p></li>
</ul>

<p><a id="x-28SENTO-2EMESSAGEB-3ASTOP-20GENERIC-FUNCTION-29"></a>
<a id="SENTO.MESSAGEB:STOP%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#SENTO.MESSAGEB:STOP%20GENERIC-FUNCTION" >STOP</a></span></span> <span class="locative-args">MESSAGE-BOX-BASE &amp;OPTIONAL WAIT</span></span></p>

<p>Stops the message processing.
The message processing is not terminated while a message is still processed.
Rather it is a graceful stop by waiting until a message has been processed.
Provide <code>wait</code> <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_eq.htm" title="EQ FUNCTION"><code>EQ</code></a> <code>T</code> to wait until the actor cell is stopped.</p></li>
</ul>

<p><a id="x-28SENTO-2EMESSAGEB-3ASTOP-20-28METHOD-20NIL-20-28SENTO-2EMESSAGEB-3AMESSAGE-BOX-BASE-29-29-29"></a>
<a id="SENTO.MESSAGEB:STOP%20%28METHOD%20NIL%20%28SENTO.MESSAGEB:MESSAGE-BOX-BASE%29%29"></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#SENTO.MESSAGEB:STOP%20%28METHOD%20NIL%20%28SENTO.MESSAGEB:MESSAGE-BOX-BASE%29%29" >STOP</a></span></span> <span class="locative-args">(SELF MESSAGE-BOX-BASE)</span></span></li>
</ul>

<p><a id="x-28SENTO-2EMESSAGEB-3AWITH-SUBMIT-HANDLER-20MGL-PAX-3AMACRO-29"></a>
<a id="SENTO.MESSAGEB:WITH-SUBMIT-HANDLER%20MGL-PAX:MACRO"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[macro]</span> <span class="reference-object"><a href="#SENTO.MESSAGEB:WITH-SUBMIT-HANDLER%20MGL-PAX:MACRO" >WITH-SUBMIT-HANDLER</a></span></span> <span class="locative-args">(MSGBOX MESSAGE WITHREPLY-P TIME-OUT) &amp;REST BODY</span></span></p>

<p>Macro to let the caller specify a message handler function.
Use this instead of <a href="#SENTO.MESSAGEB:SUBMIT%20GENERIC-FUNCTION" title="SENTO.MESSAGEB:SUBMIT GENERIC-FUNCTION"><code>submit</code></a>.</p></li>
</ul>

<p><a id="x-28SENTO-2EMESSAGEB-3A-40MESSAGE-BOX-2FBT-20MGL-PAX-3ASECTION-29"></a>
<a id="SENTO.MESSAGEB:@MESSAGE-BOX%2FBT%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#SENTO.MESSAGEB:@MESSAGE-BOX-BASE%20MGL-PAX:SECTION" title="Message-box base class">&#8592;</a> <a href="#SENTO.ACTOR:@ACTOR%20MGL-PAX:SECTION" title="Actor">&#8593;</a> <a href="#SENTO.MESSAGEB:@MESSAGE-BOX%2FDP%20MGL-PAX:SECTION" title="Message-box dispatched">&#8594;</a> <a href="#SENTO.MESSAGEB:@MESSAGE-BOX%2FBT%20MGL-PAX:SECTION" title="Message-box threaded">&#8634;</a></span></span></p>

<h4><a href="#SENTO.MESSAGEB:@MESSAGE-BOX%2FBT%20MGL-PAX:SECTION">2.3.3 Message-box threaded</a></h4>

<h6>[in package SENTO.MESSAGEB with nicknames MESGB]</h6>

<p><a id="x-28SENTO-2EMESSAGEB-3AMESSAGE-BOX-2FBT-20CLASS-29"></a>
<a id="SENTO.MESSAGEB:MESSAGE-BOX%2FBT%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[class]</span> <span class="reference-object"><a href="#SENTO.MESSAGEB:MESSAGE-BOX%2FBT%20CLASS" >MESSAGE-BOX/BT</a></span></span> <span class="locative-args"><a href="#SENTO.MESSAGEB:MESSAGE-BOX-BASE%20CLASS" title="SENTO.MESSAGEB:MESSAGE-BOX-BASE CLASS">MESSAGE-BOX-BASE</a></span></span></p>

<p>Bordeaux-Threads based message-box with a single thread operating on a message queue.
This is used when the actor is created using a <code>:pinned</code> dispatcher type.
There is a limit on the maximum number of actors/agents that can be created with
this kind of queue because each message-box (and with that each actor) requires exactly one thread.</p></li>
</ul>

<p><a id="x-28SENTO-2EMESSAGEB-3ASUBMIT-20-28METHOD-20NIL-20-28SENTO-2EMESSAGEB-3AMESSAGE-BOX-2FBT-20T-20T-20T-20T-29-29-29"></a>
<a id="SENTO.MESSAGEB:SUBMIT%20%28METHOD%20NIL%20%28SENTO.MESSAGEB:MESSAGE-BOX%2FBT%20T%20T%20T%20T%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#SENTO.MESSAGEB:SUBMIT%20%28METHOD%20NIL%20%28SENTO.MESSAGEB:MESSAGE-BOX%2FBT%20T%20T%20T%20T%29%29" >SUBMIT</a></span></span> <span class="locative-args">(SELF MESSAGE-BOX/BT) MESSAGE WITHREPLY-P TIME-OUT HANDLER-FUN</span></span></p>

<p>Alternatively use <a href="#SENTO.MESSAGEB:WITH-SUBMIT-HANDLER%20MGL-PAX:MACRO" title="SENTO.MESSAGEB:WITH-SUBMIT-HANDLER MGL-PAX:MACRO"><code>with-submit-handler</code></a> from your code to handle the message after it was 'popped' from the queue.
The <code>handler-fun</code> argument here will be <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_funcal.htm" title="FUNCALL FUNCTION"><code>funcall</code></a>ed when the message was 'popped'.</p></li>
</ul>

<p><a id="x-28SENTO-2EMESSAGEB-3A-40MESSAGE-BOX-2FDP-20MGL-PAX-3ASECTION-29"></a>
<a id="SENTO.MESSAGEB:@MESSAGE-BOX%2FDP%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#SENTO.MESSAGEB:@MESSAGE-BOX%2FBT%20MGL-PAX:SECTION" title="Message-box threaded">&#8592;</a> <a href="#SENTO.ACTOR:@ACTOR%20MGL-PAX:SECTION" title="Actor">&#8593;</a> <a href="#SENTO.FUTURE:@FUTURE%20MGL-PAX:SECTION" title="Future (delayed-computation)">&#8594;</a> <a href="#SENTO.MESSAGEB:@MESSAGE-BOX%2FDP%20MGL-PAX:SECTION" title="Message-box dispatched">&#8634;</a></span></span></p>

<h4><a href="#SENTO.MESSAGEB:@MESSAGE-BOX%2FDP%20MGL-PAX:SECTION">2.3.4 Message-box dispatched</a></h4>

<h6>[in package SENTO.MESSAGEB with nicknames MESGB]</h6>

<p><a id="x-28SENTO-2EMESSAGEB-3AMESSAGE-BOX-2FDP-20CLASS-29"></a>
<a id="SENTO.MESSAGEB:MESSAGE-BOX%2FDP%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[class]</span> <span class="reference-object"><a href="#SENTO.MESSAGEB:MESSAGE-BOX%2FDP%20CLASS" >MESSAGE-BOX/DP</a></span></span> <span class="locative-args"><a href="#SENTO.MESSAGEB:MESSAGE-BOX-BASE%20CLASS" title="SENTO.MESSAGEB:MESSAGE-BOX-BASE CLASS">MESSAGE-BOX-BASE</a></span></span></p>

<p>This message box is a message-box that uses the <code>system</code>s <code>dispatcher</code>.
This has the advantage that an almost unlimited actors/agents can be created.
This message-box doesn't 'own' a thread. It uses the <code>dispatcher</code> to handle the message processing.
The <code>dispatcher</code> is kind of like a thread pool.</p></li>
</ul>

<p><a id="x-28SENTO-2EMESSAGEB-3ASUBMIT-20-28METHOD-20NIL-20-28SENTO-2EMESSAGEB-3AMESSAGE-BOX-2FDP-20T-20T-20T-20T-29-29-29"></a>
<a id="SENTO.MESSAGEB:SUBMIT%20%28METHOD%20NIL%20%28SENTO.MESSAGEB:MESSAGE-BOX%2FDP%20T%20T%20T%20T%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#SENTO.MESSAGEB:SUBMIT%20%28METHOD%20NIL%20%28SENTO.MESSAGEB:MESSAGE-BOX%2FDP%20T%20T%20T%20T%29%29" >SUBMIT</a></span></span> <span class="locative-args">(SELF MESSAGE-BOX/DP) MESSAGE WITHREPLY-P TIME-OUT HANDLER-FUN</span></span></p>

<p>Submitting a message on a multi-threaded <code>dispatcher</code> is different as submitting on a single threaded message-box. On a single threaded message-box the order of message processing is guaranteed even when submitting from multiple threads. On the <code>dispatcher</code> this is not the case. The order cannot be guaranteed when messages are processed by different <code>dispatcher</code> threads. However, we still guarantee a 'single-threadedness' regarding the state of the actor. This is achieved here by protecting the <code>handler-fun</code> execution with a lock.</p>

<p>The <code>time-out</code> with the 'dispatcher mailbox' assumes that the message received the dispatcher queue
and the handler in a reasonable amount of time, so that the effective time-out applies on the actual
handling of the message on the dispatcher queue thread.</p></li>
</ul>

<p><a id="x-28SENTO-2EFUTURE-3A-40FUTURE-20MGL-PAX-3ASECTION-29"></a>
<a id="SENTO.FUTURE:@FUTURE%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#SENTO.MESSAGEB:@MESSAGE-BOX%2FDP%20MGL-PAX:SECTION" title="Message-box dispatched">&#8592;</a> <a href="#SENTO.ACTOR:@ACTOR%20MGL-PAX:SECTION" title="Actor">&#8593;</a> <a href="#SENTO.AGENT:@AGENT%20MGL-PAX:SECTION" title="Agent">&#8594;</a> <a href="#SENTO.FUTURE:@FUTURE%20MGL-PAX:SECTION" title="Future (delayed-computation)">&#8634;</a></span></span></p>

<h4><a href="#SENTO.FUTURE:@FUTURE%20MGL-PAX:SECTION">2.3.5 Future (delayed-computation)</a></h4>

<h6>[in package SENTO.FUTURE with nicknames FUTURE]</h6>

<p><a id="x-28SENTO-2EFUTURE-3AFUTURE-20CLASS-29"></a>
<a id="SENTO.FUTURE:FUTURE%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[class]</span> <span class="reference-object"><a href="#SENTO.FUTURE:FUTURE%20CLASS" >FUTURE</a></span></span></span></p>

<p>The wrapped <a href="https://orthecreedence.github.io/blackbird/" >blackbird</a> <code>promise</code>, here called <code>future</code>.<br/>
Not all features of blackbird's <code>promise</code> are supported.<br/>
This <code>future</code> wrapper changes the terminology. A <code>future</code> is a delayed computation.
A <code>promise</code> is the fulfillment of the delayed computation.</p></li>
</ul>

<p><a id="x-28SENTO-2EFUTURE-3AWITH-FUT-20MGL-PAX-3AMACRO-29"></a>
<a id="SENTO.FUTURE:WITH-FUT%20MGL-PAX:MACRO"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[macro]</span> <span class="reference-object"><a href="#SENTO.FUTURE:WITH-FUT%20MGL-PAX:MACRO" >WITH-FUT</a></span></span> <span class="locative-args">&amp;BODY BODY</span></span></p>

<p>Convenience macro for creating a <a href="#SENTO.FUTURE:FUTURE%20CLASS" title="SENTO.FUTURE:FUTURE CLASS"><code>future</code></a>.</p>

<p>The <code>future</code> will be resolved with the result of the body form.</p></li>
</ul>

<p><a id="x-28SENTO-2EFUTURE-3AWITH-FUT-RESOLVE-20MGL-PAX-3AMACRO-29"></a>
<a id="SENTO.FUTURE:WITH-FUT-RESOLVE%20MGL-PAX:MACRO"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[macro]</span> <span class="reference-object"><a href="#SENTO.FUTURE:WITH-FUT-RESOLVE%20MGL-PAX:MACRO" >WITH-FUT-RESOLVE</a></span></span> <span class="locative-args">&amp;BODY BODY</span></span></p>

<p>Convenience macro for creating a <a href="#SENTO.FUTURE:FUTURE%20CLASS" title="SENTO.FUTURE:FUTURE CLASS"><code>future</code></a> that must be resolved manually via <code>resolve</code>.</p>

<p>This allows to spawn threads or other asynchronous operations as part of <code>body</code>.
However, you have to <code>resolve</code> the future eventually by applying a result on <code>resolve</code>.</p>

<p>Example:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">with-fut-resolve</span></i>
  <span class="paren2">(<span class="code">bt:make-thread
   <span class="paren3">(<span class="code"><i><span class="symbol">lambda</span></i> <span class="paren4">(<span class="code"></span>)</span>
     <span class="paren4">(<span class="code">fresolve <span class="paren5">(<span class="code">do-some-lengthy-calculation</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre></li>
</ul>

<p><a id="x-28SENTO-2EFUTURE-3AMAKE-FUTURE-20FUNCTION-29"></a>
<a id="SENTO.FUTURE:MAKE-FUTURE%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.FUTURE:MAKE-FUTURE%20FUNCTION" >MAKE-FUTURE</a></span></span> <span class="locative-args">EXECUTE-FUN</span></span></p>

<p>Creates a future. <code>execute-fun</code> is the lambda that is executed when the future is created.
<code>execute-fun</code> takes a parameter which is the <code>execute-fun</code> funtion. <code>execute-fun</code> function
takes the <code>promise</code> as parameter which is the computed value. Calling <code>execute-fun</code> with the promise
will fulfill the <a href="#SENTO.FUTURE:FUTURE%20CLASS" title="SENTO.FUTURE:FUTURE CLASS"><code>future</code></a>.<br/>
Manually calling <code>execute-fun</code> to fulfill the <code>future</code> is in contrast to just fulfill the <code>future</code> from a return value. The benefit of the <code>execute-fun</code> is flexibility. In  a multi-threaded environment <code>execute-fun</code> could spawn a thread, in which case <code>execute-fun</code> would return immediately but no promise-value can be given at that time. The <code>execute-fun</code> can be called from a thread and provide the promise.</p>

<p>Create a future with:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">make-future <span class="paren2">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_330.html#IDX1006" class="symbol"><i><span class="symbol">lambda</span></i></a> <span class="paren3">(<span class="code">execute-fun</span>)</span> 
               <span class="paren3">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_141.html#IDX422" class="symbol"><i><span class="symbol">let</span></i></a> <span class="paren4">(<span class="code"><span class="paren5">(<span class="code">promise <span class="paren6">(<span class="code">delayed-computation</span>)</span></span>)</span></span>)</span>
                 <span class="paren4">(<span class="code">bt:make-thread <span class="paren5">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_330.html#IDX1006" class="symbol"><i><span class="symbol">lambda</span></i></a> <span class="paren6">(<span class="code"></span>)</span>
                   <span class="paren6">(<span class="code">sleep 0.5</span>)</span>
                   <span class="paren6">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_232.html#IDX618" class="symbol">funcall</a> execute-fun promise</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre></li>
</ul>

<p><a id="x-28SENTO-2EFUTURE-3ACOMPLETE-P-20FUNCTION-29"></a>
<a id="SENTO.FUTURE:COMPLETE-P%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.FUTURE:COMPLETE-P%20FUNCTION" >COMPLETE-P</a></span></span> <span class="locative-args">FUTURE</span></span></p>

<p>Is <code>future</code> completed? Returns either <code>t</code> or <code>nil</code>.</p></li>
</ul>

<p><a id="x-28SENTO-2EFUTURE-3AFCOMPLETED-20MGL-PAX-3AMACRO-29"></a>
<a id="SENTO.FUTURE:FCOMPLETED%20MGL-PAX:MACRO"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[macro]</span> <span class="reference-object"><a href="#SENTO.FUTURE:FCOMPLETED%20MGL-PAX:MACRO" >FCOMPLETED</a></span></span> <span class="locative-args">FUTURE (RESULT) &amp;BODY BODY</span></span></p>

<p>Completion handler on the given <code>future</code>.</p>

<p>If the <code>future</code> is already complete then the <code>body</code> executed immediately.<br/>
<code>result</code> represents the future result.
<code>body</code> is executed when future completed.</p>

<p>Example:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">fcompleted <span class="paren2">(<span class="code"><i><span class="symbol">with-fut</span></i>
              <span class="paren3">(<span class="code">sleep .5</span>)</span>
              1</span>)</span>
            <span class="paren2">(<span class="code">result</span>)</span>
  <span class="paren2">(<span class="code">format t <span class="string">"Future result ~a~%"</span> result</span>)</span></span>)</span></span></code></pre></li>
</ul>

<p><a id="x-28SENTO-2EFUTURE-3AFRESULT-20FUNCTION-29"></a>
<a id="SENTO.FUTURE:FRESULT%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.FUTURE:FRESULT%20FUNCTION" >FRESULT</a></span></span> <span class="locative-args">FUTURE</span></span></p>

<p>Get the computation result. If not yet available <code>:not-ready</code> is returned.</p></li>
</ul>

<p><a id="x-28SENTO-2EFUTURE-3AFMAP-20MGL-PAX-3AMACRO-29"></a>
<a id="SENTO.FUTURE:FMAP%20MGL-PAX:MACRO"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[macro]</span> <span class="reference-object"><a href="#SENTO.FUTURE:FMAP%20MGL-PAX:MACRO" >FMAP</a></span></span> <span class="locative-args">FUTURE (RESULT) &amp;BODY BODY</span></span></p>

<p><code>fmap</code> maps a future.</p>

<p><code>future</code> is the future that is mapped.
<code>result</code> is the result of the future when it completed.
<code>body</code> is the form that executes when the future is completed. The result of <code>body</code> generates a new future.</p>

<p>Example:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">fmap <span class="paren2">(<span class="code"><i><span class="symbol">with-fut</span></i> 0</span>)</span> <span class="paren2">(<span class="code">result</span>)</span>
  <span class="paren2">(<span class="code">1+ result</span>)</span></span>)</span></span></code></pre></li>
</ul>

<p><a id="x-28SENTO-2EFUTURE-3AFRECOVER-20MGL-PAX-3AMACRO-29"></a>
<a id="SENTO.FUTURE:FRECOVER%20MGL-PAX:MACRO"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[macro]</span> <span class="reference-object"><a href="#SENTO.FUTURE:FRECOVER%20MGL-PAX:MACRO" >FRECOVER</a></span></span> <span class="locative-args">FUTURE &amp;REST HANDLER-FORMS</span></span></p>

<p>Catch errors in futures using <code>frecover</code>
It works similar to <a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_hand_1.htm" title="HANDLER-CASE MGL-PAX:MACRO"><code>handler-case</code></a>.</p>

<p>Example:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">fresult
 <span class="paren2">(<span class="code">frecover
  <span class="paren3">(<span class="code">-&gt; <span class="paren4">(<span class="code"><i><span class="symbol">with-fut</span></i> 0</span>)</span>
    <span class="paren4">(<span class="code">fmap <span class="paren5">(<span class="code">value</span>)</span>
      <span class="paren5">(<span class="code">declare <span class="paren6">(<span class="code">ignore value</span>)</span></span>)</span>
      <span class="paren5">(<span class="code">error <span class="string">"foo"</span></span>)</span></span>)</span></span>)</span>
    <span class="paren3">(<span class="code">fmap <span class="paren4">(<span class="code">value</span>)</span>
      <span class="paren4">(<span class="code">+ value 1</span>)</span></span>)</span></span>)</span></span>)</span>
  <span class="paren1">(<span class="code">error <span class="paren2">(<span class="code">c</span>)</span> <span class="paren2">(<span class="code">format nil <span class="string">"~a"</span> c</span>)</span></span>)</span>))</span></code></pre></li>
</ul>

<p><a id="x-28SENTO-2EAGENT-3A-40AGENT-20MGL-PAX-3ASECTION-29"></a>
<a id="SENTO.AGENT:@AGENT%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#SENTO.FUTURE:@FUTURE%20MGL-PAX:SECTION" title="Future (delayed-computation)">&#8592;</a> <a href="#SENTO.DOCS:@API%20MGL-PAX:SECTION" title="API documentation">&#8593;</a> <a href="#SENTO.AGENT.HASH:@HASH-AGENT%20MGL-PAX:SECTION" title="Hash-table agent">&#8594;</a> <a href="#SENTO.AGENT:@AGENT%20MGL-PAX:SECTION" title="Agent">&#8634;</a></span></span></p>

<h3><a href="#SENTO.AGENT:@AGENT%20MGL-PAX:SECTION">2.4 Agent</a></h3>

<h6>[in package SENTO.AGENT with nicknames AGT]</h6>

<p><a id="x-28SENTO-2EAGENT-3AAGENT-20CLASS-29"></a>
<a id="SENTO.AGENT:AGENT%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[class]</span> <span class="reference-object"><a href="#SENTO.AGENT:AGENT%20CLASS" >AGENT</a></span></span> <span class="locative-args"><a href="#SENTO.ACTOR:ACTOR%20CLASS" title="SENTO.ACTOR:ACTOR CLASS">ACTOR</a></span></span></p>

<p>Specialized <a href="#SENTO.ACTOR:ACTOR%20CLASS" title="SENTO.ACTOR:ACTOR CLASS"><code>actor</code></a> class called <code>agent</code>.
It is meant primarily to encapsulate state.
To access state it provides <a href="#SENTO.AGENT:AGENT-GET%20FUNCTION" title="SENTO.AGENT:AGENT-GET FUNCTION"><code>agent-get</code></a> and <a href="#SENTO.AGENT:AGENT-UPDATE%20FUNCTION" title="SENTO.AGENT:AGENT-UPDATE FUNCTION"><code>agent-update</code></a> to update state.
Stop an agent with <a href="#SENTO.AGENT:AGENT-STOP%20FUNCTION" title="SENTO.AGENT:AGENT-STOP FUNCTION"><code>agent-stop</code></a> to free resources (threads).</p></li>
</ul>

<p><a id="x-28SENTO-2EAGENT-3AMAKE-AGENT-20FUNCTION-29"></a>
<a id="SENTO.AGENT:MAKE-AGENT%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.AGENT:MAKE-AGENT%20FUNCTION" >MAKE-AGENT</a></span></span> <span class="locative-args">STATE-FUN &amp;OPTIONAL ACTOR-CONTEXT (DISPATCHER-ID <code>:SHARED</code>)</span></span></p>

<p>Makes a new <a href="#SENTO.AGENT:AGENT%20CLASS" title="SENTO.AGENT:AGENT CLASS"><code>agent</code></a> instance.</p>

<p><code>state-fun</code> is a function that takes no parameter and provides the initial state of the <code>agent</code> as return value.</p>

<p><code>actor-context</code>: optionally specify an <a href="#SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%20CLASS" title="SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM CLASS"><code>asys:actor-system</code></a> as <a href="#SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT%20CLASS" title="SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT CLASS"><code>ac:actor-context</code></a>. If specified the agent will be registered in the system and destroyed with it should the <code>asys:actor-system</code> be destroyed. In addition the agent will use the systems shared message dispatcher and will <em>not</em> create it's own.</p>

<p><code>dispatcher-id</code>: the dispatcher is configurable. Default is <code>:shared</code>. But you may use also <code>:pinned</code> or a custom configured one. Be aware that <code>:shared</code> of a custom dispatcher only works if an <code>actor-context</code> was specified.</p></li>
</ul>

<p><a id="x-28SENTO-2EAGENT-3AAGENT-GET-20FUNCTION-29"></a>
<a id="SENTO.AGENT:AGENT-GET%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.AGENT:AGENT-GET%20FUNCTION" >AGENT-GET</a></span></span> <span class="locative-args">AGENT GET-FUN</span></span></p>

<p>Gets the current state of the <code>agent</code>.
<code>get-fun</code> must accept one parameter. That is the current-state of the <code>agent</code>.
To return the current state <code>get-fun</code> may be just the <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_identi.htm" title="IDENTITY FUNCTION"><code>identity</code></a> function.</p></li>
</ul>

<p><a id="x-28SENTO-2EAGENT-3AAGENT-UPDATE-20FUNCTION-29"></a>
<a id="SENTO.AGENT:AGENT-UPDATE%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.AGENT:AGENT-UPDATE%20FUNCTION" >AGENT-UPDATE</a></span></span> <span class="locative-args">AGENT UPDATE-FUN</span></span></p>

<p>Updates the <code>agent</code> state.
<code>update-fun</code> must accept one parameter. That is the current state of the <code>agent</code>.
The return value of <code>update-fun</code> will be taken as the new state of the <code>agent</code>.</p></li>
</ul>

<p><a id="x-28SENTO-2EAGENT-3AAGENT-UPDATE-AND-GET-20FUNCTION-29"></a>
<a id="SENTO.AGENT:AGENT-UPDATE-AND-GET%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.AGENT:AGENT-UPDATE-AND-GET%20FUNCTION" >AGENT-UPDATE-AND-GET</a></span></span> <span class="locative-args">AGENT UPDATE-FUN</span></span></p>

<p>Updates the <code>agent</code> state.
<code>update-fun</code> must accept one parameter. That is the current state of the <code>agent</code>.
The return value of <code>update-fun</code> will be taken as the new state of the <code>agent</code>.
This function makes the update and returns the new value.</p></li>
</ul>

<p><a id="x-28SENTO-2EAGENT-3AAGENT-STOP-20FUNCTION-29"></a>
<a id="SENTO.AGENT:AGENT-STOP%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.AGENT:AGENT-STOP%20FUNCTION" >AGENT-STOP</a></span></span> <span class="locative-args">AGENT</span></span></p>

<p>Stops the message handling of the agent.</p></li>
</ul>

<p><a id="x-28SENTO-2EAGENT-2EHASH-3A-40HASH-AGENT-20MGL-PAX-3ASECTION-29"></a>
<a id="SENTO.AGENT.HASH:@HASH-AGENT%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#SENTO.AGENT:@AGENT%20MGL-PAX:SECTION" title="Agent">&#8592;</a> <a href="#SENTO.AGENT:@AGENT%20MGL-PAX:SECTION" title="Agent">&#8593;</a> <a href="#SENTO.AGENT.ARRAY:@ARRAY-AGENT%20MGL-PAX:SECTION" title="Array/Vector agent">&#8594;</a> <a href="#SENTO.AGENT.HASH:@HASH-AGENT%20MGL-PAX:SECTION" title="Hash-table agent">&#8634;</a></span></span></p>

<h4><a href="#SENTO.AGENT.HASH:@HASH-AGENT%20MGL-PAX:SECTION">2.4.1 Hash-table agent</a></h4>

<h6>[in package SENTO.AGENT.HASH with nicknames AGTHASH]</h6>

<p><a id="x-28SENTO-2EAGENT-2EHASH-3AMAKE-HASH-AGENT-20FUNCTION-29"></a>
<a id="SENTO.AGENT.HASH:MAKE-HASH-AGENT%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.AGENT.HASH:MAKE-HASH-AGENT%20FUNCTION" >MAKE-HASH-AGENT</a></span></span> <span class="locative-args">CONTEXT &amp;KEY INITIAL-HASH-TABLE (ERROR-FUN <code>NIL</code>) (DISPATCHER-ID <code>:SHARED</code>)</span></span></p>

<p>Creates an agent that wraps a CL hash-table.</p>

<p><code>context</code>: something implementing <a href="#SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT%20CLASS" title="SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT CLASS"><code>ac:actor-context</code></a> protocol like <a href="#SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%20CLASS" title="SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM CLASS"><code>asys:actor-system</code></a>. Specifying <code>nil</code> here creates an agent outside of an actor system. The user has to take care of that himself.<br/>
<code>initial-hash-table</code>: specify an initial hash-table.<br/>
<code>error-fun</code>: a 1-arrity function taking a condition that was raised.
Use this to get notified of error when using the update functions of the agent.<br/>
<code>dispatcher-id</code>: a dispatcher. defaults to <code>:shared</code>.</p></li>
</ul>

<p><a id="x-28SENTO-2EAGENT-2EHASH-3AAGENT-GETHASH-20FUNCTION-29"></a>
<a id="SENTO.AGENT.HASH:AGENT-GETHASH%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.AGENT.HASH:AGENT-GETHASH%20FUNCTION" >AGENT-GETHASH</a></span></span> <span class="locative-args">KEY HASH-AGENT</span></span></p>

<p>Retrieves value from hash-table, or <code>nil</code> if it doesn't exist.
See <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_gethas.htm" title="GETHASH FUNCTION"><code>cl:gethash</code></a> for more info.</p>

<p>This supports setting a hash using <a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_setf.htm" title="SETF MGL-PAX:MACRO"><code>setf</code></a> in the same way as with <a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_hash_t.htm" title="HASH-TABLE TYPE"><code>cl:hash-table</code></a>.</p>

<p>Returns any raised condition or the value from <code>gethash</code>.</p></li>
</ul>

<p><a id="x-28SENTO-2EAGENT-2EHASH-3AAGENT-REMHASH-20FUNCTION-29"></a>
<a id="SENTO.AGENT.HASH:AGENT-REMHASH%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.AGENT.HASH:AGENT-REMHASH%20FUNCTION" >AGENT-REMHASH</a></span></span> <span class="locative-args">KEY HASH-AGENT</span></span></p>

<p>Delete a hash-table entry. See <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_remhas.htm" title="REMHASH FUNCTION"><code>cl:remhash</code></a>.
Returns <code>t</code> if entry existed, <code>nil</code> otherwise.</p></li>
</ul>

<p><a id="x-28SENTO-2EAGENT-2EHASH-3AAGENT-CLRHASH-20FUNCTION-29"></a>
<a id="SENTO.AGENT.HASH:AGENT-CLRHASH%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.AGENT.HASH:AGENT-CLRHASH%20FUNCTION" >AGENT-CLRHASH</a></span></span> <span class="locative-args">HASH-AGENT</span></span></p>

<p>Clears the hash-table. See <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_clrhas.htm" title="CLRHASH FUNCTION"><code>cl:clrhash</code></a>.</p></li>
</ul>

<p><a id="x-28SENTO-2EAGENT-2EHASH-3AAGENT-DOHASH-20FUNCTION-29"></a>
<a id="SENTO.AGENT.HASH:AGENT-DOHASH%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.AGENT.HASH:AGENT-DOHASH%20FUNCTION" >AGENT-DOHASH</a></span></span> <span class="locative-args">FUN HASH-AGENT</span></span></p>

<p>'Do' arbitrary atomic operation on the hash-table.</p>

<p><code>fun</code>: is a 1-arity function taking the hash-table. This function can operate on the hash-table without interference from other threads. The result of this function must be a hash-table.<br/>
<code>hash-agent</code>: is the <code>hash-agent</code> instance.</p>

<p>The result of <code>agent-dohash</code> is <code>T</code>.</p></li>
</ul>

<p><a id="x-28SENTO-2EAGENT-2EARRAY-3A-40ARRAY-AGENT-20MGL-PAX-3ASECTION-29"></a>
<a id="SENTO.AGENT.ARRAY:@ARRAY-AGENT%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#SENTO.AGENT.HASH:@HASH-AGENT%20MGL-PAX:SECTION" title="Hash-table agent">&#8592;</a> <a href="#SENTO.AGENT:@AGENT%20MGL-PAX:SECTION" title="Agent">&#8593;</a> <a href="#SENTO.DISPATCHER:@DISPATCHER%20MGL-PAX:SECTION" title="Dispatcher">&#8594;</a> <a href="#SENTO.AGENT.ARRAY:@ARRAY-AGENT%20MGL-PAX:SECTION" title="Array/Vector agent">&#8634;</a></span></span></p>

<h4><a href="#SENTO.AGENT.ARRAY:@ARRAY-AGENT%20MGL-PAX:SECTION">2.4.2 Array/Vector agent</a></h4>

<h6>[in package SENTO.AGENT.ARRAY with nicknames AGTARRAY]</h6>

<p><a id="x-28SENTO-2EAGENT-2EARRAY-3AMAKE-ARRAY-AGENT-20FUNCTION-29"></a>
<a id="SENTO.AGENT.ARRAY:MAKE-ARRAY-AGENT%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.AGENT.ARRAY:MAKE-ARRAY-AGENT%20FUNCTION" >MAKE-ARRAY-AGENT</a></span></span> <span class="locative-args">CONTEXT &amp;KEY INITIAL-ARRAY (ERROR-FUN <code>NIL</code>) (DISPATCHER-ID <code>:SHARED</code>)</span></span></p>

<p>Creates an agent that wraps a CL array/vector.</p>

<p><code>context</code>: something implementing <a href="#SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT%20CLASS" title="SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT CLASS"><code>ac:actor-context</code></a> protocol like <a href="#SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%20CLASS" title="SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM CLASS"><code>asys:actor-system</code></a>. Specifying <code>nil</code> here creates an agent outside of an actor system. The user has to take care of that himself.<br/>
<code>initial-array</code>: specify an initial array/vector.<br/>
<code>error-fun</code>: a 1-arrity function taking a condition that was raised.
Use this to get notified of error when using the update functions of the agent.<br/>
<code>dispatcher-id</code>: a dispatcher. defaults to <code>:shared</code>.</p></li>
</ul>

<p><a id="x-28SENTO-2EAGENT-2EARRAY-3AAGENT-ELT-20FUNCTION-29"></a>
<a id="SENTO.AGENT.ARRAY:AGENT-ELT%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.AGENT.ARRAY:AGENT-ELT%20FUNCTION" >AGENT-ELT</a></span></span> <span class="locative-args">INDEX ARRAY-AGENT</span></span></p>

<p>Retrieves the value of the specified index of the array. <code>agent-elt</code> allows <a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_setf.htm" title="SETF MGL-PAX:MACRO"><code>setf</code></a>ing like:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">setf <span class="paren2">(<span class="code">agent-elt 0 cut</span>)</span> 11</span>)</span></span></code></pre>

<p><code>index</code>: the index to retrieve.<br/>
<code>array-agent</code>: the array agent instance.</p>

<p>In case of error <code>agent-elt</code> returns the error condition that <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_elt.htm" title="ELT FUNCTION"><code>elt</code></a> raises.</p>

<p>The <code>setf</code> functionality will call <code>err-fun</code> on error if it has been configured.</p></li>
</ul>

<p><a id="x-28SENTO-2EAGENT-2EARRAY-3AAGENT-PUSH-20FUNCTION-29"></a>
<a id="SENTO.AGENT.ARRAY:AGENT-PUSH%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.AGENT.ARRAY:AGENT-PUSH%20FUNCTION" >AGENT-PUSH</a></span></span> <span class="locative-args">ITEM ARRAY-AGENT</span></span></p>

<p>Pushes a value to the array/vector. Internally uses <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_vec_ps.htm" title="VECTOR-PUSH-EXTEND FUNCTION"><code>vector-push-extend</code></a>, so the array must have a <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_fill_p.htm" title="FILL-POINTER FUNCTION"><code>fill-pointer</code></a>.</p>

<p><code>item</code>: item to push.<br/>
<code>array-agent</code>: the array agent instance.</p>

<p>On error it will call <code>err-fun</code> with the raised condition, if <code>err-fun</code> has been configured.</p></li>
</ul>

<p><a id="x-28SENTO-2EAGENT-2EARRAY-3AAGENT-PUSH-AND-GETIDX-20FUNCTION-29"></a>
<a id="SENTO.AGENT.ARRAY:AGENT-PUSH-AND-GETIDX%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.AGENT.ARRAY:AGENT-PUSH-AND-GETIDX%20FUNCTION" >AGENT-PUSH-AND-GETIDX</a></span></span> <span class="locative-args">ITEM ARRAY-AGENT</span></span></p>

<p>Pushes <code>item</code> to the array. This function is similar to <a href="#SENTO.AGENT.ARRAY:AGENT-PUSH%20FUNCTION" title="SENTO.AGENT.ARRAY:AGENT-PUSH FUNCTION"><code>agent-push</code></a> but returns the index of the pushed value similar as <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_vec_ps.htm" title="VECTOR-PUSH FUNCTION"><code>vector-push</code></a> does. Therefore it is based on the somewhat slower <code>ask-s</code> actor pattern. So if you don't care about the new index of the pushed item use <code>agent-push</code> instead. But this one is able to immediately return error conditions that may occur on <code>vector-push</code>.</p>

<p><code>item</code>: item to push.<br/>
<code>array-agent</code>: the array agent instance.</p></li>
</ul>

<p><a id="x-28SENTO-2EAGENT-2EARRAY-3AAGENT-POP-20FUNCTION-29"></a>
<a id="SENTO.AGENT.ARRAY:AGENT-POP%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.AGENT.ARRAY:AGENT-POP%20FUNCTION" >AGENT-POP</a></span></span> <span class="locative-args">ARRAY-AGENT</span></span></p>

<p>Pops from array and returns the popped value. Internally uses <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_vec_po.htm" title="VECTOR-POP FUNCTION"><code>vector-pop</code></a>, so the array must have a <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_fill_p.htm" title="FILL-POINTER FUNCTION"><code>fill-pointer</code></a>. In case of error from using <code>vector-pop</code> the condition is returned.</p>

<p><code>array-agent</code>: the array agent instance.</p></li>
</ul>

<p><a id="x-28SENTO-2EAGENT-2EARRAY-3AAGENT-DELETE-20FUNCTION-29"></a>
<a id="SENTO.AGENT.ARRAY:AGENT-DELETE%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.AGENT.ARRAY:AGENT-DELETE%20FUNCTION" >AGENT-DELETE</a></span></span> <span class="locative-args">ITEM ARRAY-AGENT &amp;REST DELETE-ARGS</span></span></p>

<p>Deletes item from array. Internally uses <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_rm_rm.htm" title="DELETE FUNCTION"><code>delete</code></a>. Returns <code>T</code>.</p>

<p><code>item</code>: the item to delete.<br/>
<code>array-agent</code>: the array agent instance.<br/>
<code>delete-args</code>: any arguments passed on to <code>delete</code>.</p></li>
</ul>

<p><a id="x-28SENTO-2EAGENT-2EARRAY-3AAGENT-DOARRAY-20FUNCTION-29"></a>
<a id="SENTO.AGENT.ARRAY:AGENT-DOARRAY%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.AGENT.ARRAY:AGENT-DOARRAY%20FUNCTION" >AGENT-DOARRAY</a></span></span> <span class="locative-args">FUN ARRAY-AGENT</span></span></p>

<p>'Do' arbitrary atomic operation on the array.</p>

<p><code>fun</code>: is a 1-arity function taking the array. This function can operate on the array without interference from other threads. The result of this function must be an array which will be the new agent state.<br/>
<code>array-agent</code>: is the <code>array-agent</code> instance.</p>

<p>The result of <code>agent-doarray</code> is <code>T</code>.</p></li>
</ul>

<p><a id="x-28SENTO-2EDISPATCHER-3A-40DISPATCHER-20MGL-PAX-3ASECTION-29"></a>
<a id="SENTO.DISPATCHER:@DISPATCHER%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#SENTO.AGENT.ARRAY:@ARRAY-AGENT%20MGL-PAX:SECTION" title="Array/Vector agent">&#8592;</a> <a href="#SENTO.DOCS:@API%20MGL-PAX:SECTION" title="API documentation">&#8593;</a> <a href="#SENTO.DISPATCHER:@SHARED-DISPATCHER%20MGL-PAX:SECTION" title="Shared dispatcher">&#8594;</a> <a href="#SENTO.DISPATCHER:@DISPATCHER%20MGL-PAX:SECTION" title="Dispatcher">&#8634;</a></span></span></p>

<h3><a href="#SENTO.DISPATCHER:@DISPATCHER%20MGL-PAX:SECTION">2.5 Dispatcher</a></h3>

<h6>[in package SENTO.DISPATCHER with nicknames DISP]</h6>

<p><a id="x-28SENTO-2EDISPATCHER-3ADISPATCHER-BASE-20CLASS-29"></a>
<a id="SENTO.DISPATCHER:DISPATCHER-BASE%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[class]</span> <span class="reference-object"><a href="#SENTO.DISPATCHER:DISPATCHER-BASE%20CLASS" >DISPATCHER-BASE</a></span></span></span></p>

<p>A <code>dispatcher</code> contains a pool of <a href="#SENTO.ACTOR:ACTOR%20CLASS" title="SENTO.ACTOR:ACTOR CLASS"><code>actors</code></a> that operate as workers where work is dispatched to.
However, the workers are created in the given <a href="#SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT%20CLASS" title="SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT CLASS"><code>ac:actor-context</code></a>.</p></li>
</ul>

<p><a id="x-28SENTO-2EDISPATCHER-3AIDENTIFIER-20-28MGL-PAX-3AREADER-20SENTO-2EDISPATCHER-3ADISPATCHER-BASE-29-29"></a>
<a id="SENTO.DISPATCHER:IDENTIFIER%20%28MGL-PAX:READER%20SENTO.DISPATCHER:DISPATCHER-BASE%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[reader]</span> <span class="reference-object"><a href="#SENTO.DISPATCHER:IDENTIFIER%20%28MGL-PAX:READER%20SENTO.DISPATCHER:DISPATCHER-BASE%29" >IDENTIFIER</a></span></span> <span class="locative-args">DISPATCHER-BASE (:IDENTIFIER = NIL)</span></span></p>

<p>Returns the identifier of the dispatcher.</p></li>
</ul>

<p><a id="x-28SENTO-2EDISPATCHER-3AMAKE-DISPATCHER-20FUNCTION-29"></a>
<a id="SENTO.DISPATCHER:MAKE-DISPATCHER%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.DISPATCHER:MAKE-DISPATCHER%20FUNCTION" >MAKE-DISPATCHER</a></span></span> <span class="locative-args">ACTOR-CONTEXT IDENTIFIER &amp;REST CONFIG</span></span></p>

<p>Default constructor.
This creates a <a href="#SENTO.DISPATCHER:SHARED-DISPATCHER%20CLASS" title="SENTO.DISPATCHER:SHARED-DISPATCHER CLASS"><code>disp:shared-dispatcher</code></a> with the given dispatcher config, see <a href="#SENTO.ACTOR-SYSTEM:*DEFAULT-CONFIG*%20VARIABLE" title="SENTO.ACTOR-SYSTEM:*DEFAULT-CONFIG* VARIABLE"><code>asys:*default-config*</code></a>.
Each worker is based on a <code>:pinned</code> actor meaning that it has its own thread.
Specify an <a href="#SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT%20CLASS" title="SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT CLASS"><code>ac:actor-context</code></a> where actors needed in the dispatcher are created in.</p></li>
</ul>

<p><a id="x-28SENTO-2EDISPATCHER-3ADISPATCH-20GENERIC-FUNCTION-29"></a>
<a id="SENTO.DISPATCHER:DISPATCH%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#SENTO.DISPATCHER:DISPATCH%20GENERIC-FUNCTION" >DISPATCH</a></span></span> <span class="locative-args">DISPATCHER DISPATCHER-EXEC-FUN</span></span></p>

<p>Dispatches a function (<code>dispatch-exec-fun</code>) to a worker of the dispatcher to execute there.
<code>dispatch</code> does a <code>ask-s</code> to a <code>dispatcher</code> worker, which means this call will block.</p></li>
</ul>

<p><a id="x-28SENTO-2EDISPATCHER-3ADISPATCH-ASYNC-20GENERIC-FUNCTION-29"></a>
<a id="SENTO.DISPATCHER:DISPATCH-ASYNC%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#SENTO.DISPATCHER:DISPATCH-ASYNC%20GENERIC-FUNCTION" >DISPATCH-ASYNC</a></span></span> <span class="locative-args">DISPATCHER DISPATCHER-EXEC-FUN</span></span></p>

<p>Dispatches a function to a worker of the dispatcher to execute there.
<code>dispatch-async</code> does a <code>tell</code> to a <code>dispatcher</code> worker and is asynchronous.</p></li>
</ul>

<p><a id="x-28SENTO-2EDISPATCHER-3ASTOP-20GENERIC-FUNCTION-29"></a>
<a id="SENTO.DISPATCHER:STOP%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#SENTO.DISPATCHER:STOP%20GENERIC-FUNCTION" >STOP</a></span></span> <span class="locative-args">DISPATCHER</span></span></p>

<p>Stops the dispatcher. Stops all workers.</p></li>
</ul>

<p><a id="x-28SENTO-2EDISPATCHER-3AWORKERS-20GENERIC-FUNCTION-29"></a>
<a id="SENTO.DISPATCHER:WORKERS%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#SENTO.DISPATCHER:WORKERS%20GENERIC-FUNCTION" >WORKERS</a></span></span> <span class="locative-args">DISPATCHER</span></span></p>

<p>Returns the workers of this dispatcher.
But better do not touch them.
Only use the defined interface here to talk to them.</p></li>
</ul>

<p><a id="x-28SENTO-2EDISPATCHER-3ADISPATCH-WORKER-20CLASS-29"></a>
<a id="SENTO.DISPATCHER:DISPATCH-WORKER%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[class]</span> <span class="reference-object"><a href="#SENTO.DISPATCHER:DISPATCH-WORKER%20CLASS" >DISPATCH-WORKER</a></span></span> <span class="locative-args"><a href="#SENTO.ACTOR:ACTOR%20CLASS" title="SENTO.ACTOR:ACTOR CLASS">ACTOR</a></span></span></p>

<p>Specialized <a href="#SENTO.ACTOR:ACTOR%20CLASS" title="SENTO.ACTOR:ACTOR CLASS"><code>actor</code></a> used as <code>worker</code> is the message <code>dispatcher</code>.</p></li>
</ul>

<p><a id="x-28SENTO-2EDISPATCHER-3AMAKE-DISPATCHER-WORKER-20FUNCTION-29"></a>
<a id="SENTO.DISPATCHER:MAKE-DISPATCHER-WORKER%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.DISPATCHER:MAKE-DISPATCHER-WORKER%20FUNCTION" >MAKE-DISPATCHER-WORKER</a></span></span> <span class="locative-args">NUM ACTOR-CONTEXT DISPATCHER-IDENT</span></span></p>

<p>Constructor for creating a worker.
<code>num</code> only has the purpose to give the worker a name which includes a number.
`dispatcher-ident is the dispatcher identifier.</p></li>
</ul>

<p><a id="x-28SENTO-2EDISPATCHER-3A-40SHARED-DISPATCHER-20MGL-PAX-3ASECTION-29"></a>
<a id="SENTO.DISPATCHER:@SHARED-DISPATCHER%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#SENTO.DISPATCHER:@DISPATCHER%20MGL-PAX:SECTION" title="Dispatcher">&#8592;</a> <a href="#SENTO.DISPATCHER:@DISPATCHER%20MGL-PAX:SECTION" title="Dispatcher">&#8593;</a> <a href="#SENTO.ROUTER:@ROUTER%20MGL-PAX:SECTION" title="Router">&#8594;</a> <a href="#SENTO.DISPATCHER:@SHARED-DISPATCHER%20MGL-PAX:SECTION" title="Shared dispatcher">&#8634;</a></span></span></p>

<h4><a href="#SENTO.DISPATCHER:@SHARED-DISPATCHER%20MGL-PAX:SECTION">2.5.1 Shared dispatcher</a></h4>

<p><a id="x-28SENTO-2EDISPATCHER-3ASHARED-DISPATCHER-20CLASS-29"></a>
<a id="SENTO.DISPATCHER:SHARED-DISPATCHER%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[class]</span> <span class="reference-object"><a href="#SENTO.DISPATCHER:SHARED-DISPATCHER%20CLASS" >SHARED-DISPATCHER</a></span></span> <span class="locative-args"><a href="#SENTO.DISPATCHER:DISPATCHER-BASE%20CLASS" title="SENTO.DISPATCHER:DISPATCHER-BASE CLASS">DISPATCHER-BASE</a></span></span></p>

<p>A shared dispatcher.
Internally it uses a <a href="#SENTO.ROUTER:ROUTER%20CLASS" title="SENTO.ROUTER:ROUTER CLASS"><code>router:router</code></a> to drive the <a href="#SENTO.DISPATCHER:DISPATCH-WORKER%20CLASS" title="SENTO.DISPATCHER:DISPATCH-WORKER CLASS"><code>dispatch-worker</code></a>s.
The default strategy of choosing a worker is <code>:random</code>.</p>

<p>A <code>shared-dispatcher</code> is automatically setup by an <a href="#SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%20CLASS" title="SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM CLASS"><code>asys:actor-system</code></a>.</p></li>
</ul>

<p><a id="x-28SENTO-2EROUTER-3A-40ROUTER-20MGL-PAX-3ASECTION-29"></a>
<a id="SENTO.ROUTER:@ROUTER%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#SENTO.DISPATCHER:@SHARED-DISPATCHER%20MGL-PAX:SECTION" title="Shared dispatcher">&#8592;</a> <a href="#SENTO.DOCS:@API%20MGL-PAX:SECTION" title="API documentation">&#8593;</a> <a href="#SENTO.EVENTSTREAM:@EVENTSTREAM%20MGL-PAX:SECTION" title="Eventstream">&#8594;</a> <a href="#SENTO.ROUTER:@ROUTER%20MGL-PAX:SECTION" title="Router">&#8634;</a></span></span></p>

<h3><a href="#SENTO.ROUTER:@ROUTER%20MGL-PAX:SECTION">2.6 Router</a></h3>

<h6>[in package SENTO.ROUTER with nicknames ROUTER]</h6>

<p><a id="x-28SENTO-2EROUTER-3AROUTER-20CLASS-29"></a>
<a id="SENTO.ROUTER:ROUTER%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[class]</span> <span class="reference-object"><a href="#SENTO.ROUTER:ROUTER%20CLASS" >ROUTER</a></span></span></span></p>

<p>A router combines a pool of actors and implements the actor-api protocol.
So a <a href="#SENTO.ACTOR:TELL%20GENERIC-FUNCTION" title="SENTO.ACTOR:TELL GENERIC-FUNCTION"><code>tell</code></a>, <a href="#SENTO.ACTOR:ASK-S%20GENERIC-FUNCTION" title="SENTO.ACTOR:ASK-S GENERIC-FUNCTION"><code>ask-s</code></a> and <a href="#SENTO.ACTOR:ASK%20GENERIC-FUNCTION" title="SENTO.ACTOR:ASK GENERIC-FUNCTION"><code>ask</code></a> is delegated to one of the routers routees.
While a router implements parts of the actor protocol it doesn't implement all.
I.e. a router cannot be <code>watch</code>ed.
A router <code>strategy</code> defines how one of the actors is determined as the forwarding target of the message.</p></li>
</ul>

<p><a id="x-28SENTO-2EROUTER-3AMAKE-ROUTER-20FUNCTION-29"></a>
<a id="SENTO.ROUTER:MAKE-ROUTER%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.ROUTER:MAKE-ROUTER%20FUNCTION" >MAKE-ROUTER</a></span></span> <span class="locative-args">&amp;KEY (STRATEGY <code>:RANDOM</code>) (ROUTEES <code>NIL</code>)</span></span></p>

<p>Default constructor of router.
Built-in strategies: <code>:random</code>, <code>:round-robin</code>.
Specify your own strategy by providing a function that takes a <a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_fixnum.htm" title="FIXNUM TYPE"><code>fixnum</code></a> as parameter which represents the number of routees and returns a <code>fixnum</code> that represents the index of the routee to choose.</p>

<p>Specify <code>routees</code> if you know them upfront.</p></li>
</ul>

<p><a id="x-28SENTO-2EROUTER-3AADD-ROUTEE-20FUNCTION-29"></a>
<a id="SENTO.ROUTER:ADD-ROUTEE%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.ROUTER:ADD-ROUTEE%20FUNCTION" >ADD-ROUTEE</a></span></span> <span class="locative-args">ROUTER ROUTEE</span></span></p>

<p>Adds a routee/actor to the router.</p></li>
</ul>

<p><a id="x-28SENTO-2EROUTER-3ASTOP-20FUNCTION-29"></a>
<a id="SENTO.ROUTER:STOP%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.ROUTER:STOP%20FUNCTION" >STOP</a></span></span> <span class="locative-args">ROUTER</span></span></p>

<p>Stops all routees.</p></li>
</ul>

<p><a id="x-28SENTO-2EROUTER-3AROUTEES-20FUNCTION-29"></a>
<a id="SENTO.ROUTER:ROUTEES%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.ROUTER:ROUTEES%20FUNCTION" >ROUTEES</a></span></span> <span class="locative-args">ROUTER</span></span></p>

<p>Returns the routees as list.</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-3ATELL-20-28METHOD-20NIL-20-28SENTO-2EROUTER-3AROUTER-20T-29-29-29"></a>
<a id="SENTO.ACTOR:TELL%20%28METHOD%20NIL%20%28SENTO.ROUTER:ROUTER%20T%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#SENTO.ACTOR:TELL%20%28METHOD%20NIL%20%28SENTO.ROUTER:ROUTER%20T%29%29" >TELL</a></span></span> <span class="locative-args">(SELF ROUTER) MESSAGE</span></span></p>

<p>Posts the message to one routee. The routee is chosen from the router <code>strategy</code>.
Otherwise see: <code>act:tell</code>.</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-3AASK-S-20-28METHOD-20NIL-20-28SENTO-2EROUTER-3AROUTER-20T-29-29-29"></a>
<a id="SENTO.ACTOR:ASK-S%20%28METHOD%20NIL%20%28SENTO.ROUTER:ROUTER%20T%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#SENTO.ACTOR:ASK-S%20%28METHOD%20NIL%20%28SENTO.ROUTER:ROUTER%20T%29%29" >ASK-S</a></span></span> <span class="locative-args">(SELF ROUTER) MESSAGE</span></span></p>

<p>Posts the message to one routee. The routee is chosen from the router <code>strategy</code>.
Otherwise see: <code>act:ask-s</code>.</p></li>
</ul>

<p><a id="x-28SENTO-2EACTOR-3AASK-20-28METHOD-20NIL-20-28SENTO-2EROUTER-3AROUTER-20T-29-29-29"></a>
<a id="SENTO.ACTOR:ASK%20%28METHOD%20NIL%20%28SENTO.ROUTER:ROUTER%20T%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#SENTO.ACTOR:ASK%20%28METHOD%20NIL%20%28SENTO.ROUTER:ROUTER%20T%29%29" >ASK</a></span></span> <span class="locative-args">(SELF ROUTER) MESSAGE</span></span></p>

<p>Posts the message to one routee. The routee is chosen from the router <code>strategy</code>.
Otherwise see: <code>act:ask</code>.</p></li>
</ul>

<p><a id="x-28SENTO-2EEVENTSTREAM-3A-40EVENTSTREAM-20MGL-PAX-3ASECTION-29"></a>
<a id="SENTO.EVENTSTREAM:@EVENTSTREAM%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#SENTO.ROUTER:@ROUTER%20MGL-PAX:SECTION" title="Router">&#8592;</a> <a href="#SENTO.DOCS:@API%20MGL-PAX:SECTION" title="API documentation">&#8593;</a> <a href="#SENTO.TASKS:@TASKS%20MGL-PAX:SECTION" title="Tasks">&#8594;</a> <a href="#SENTO.EVENTSTREAM:@EVENTSTREAM%20MGL-PAX:SECTION" title="Eventstream">&#8634;</a></span></span></p>

<h3><a href="#SENTO.EVENTSTREAM:@EVENTSTREAM%20MGL-PAX:SECTION">2.7 Eventstream</a></h3>

<h6>[in package SENTO.EVENTSTREAM with nicknames EV]</h6>

<p><a id="x-28SENTO-2EEVENTSTREAM-3AEVENTSTREAM-20CLASS-29"></a>
<a id="SENTO.EVENTSTREAM:EVENTSTREAM%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[class]</span> <span class="reference-object"><a href="#SENTO.EVENTSTREAM:EVENTSTREAM%20CLASS" >EVENTSTREAM</a></span></span></span></p>

<p>Eventstream facility allows to post/publish messages/events in the <a href="#SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%20CLASS" title="SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM CLASS"><code>asys:actor-system</code></a> and actors that did subscribe, to listen on those events.</p>

<p>The eventstream is driven by an actor. The processing of the sent events is guaranteed to be as they arrive.</p>

<p>Events can be posted as plain strings, as lists, or as objects of classes.
The subscriber has a variaty of options to define what to listen for.</p>

<p>For example: a subscriber wants to listen to events/messages with the string &quot;Foo&quot;.
The subscriber is then only notified when events are posted with the exact same string.</p>

<p>See more information at the <a href="#SENTO.EVENTSTREAM:SUBSCRIBE%20GENERIC-FUNCTION" title="SENTO.EVENTSTREAM:SUBSCRIBE GENERIC-FUNCTION"><code>ev:subscribe</code></a> function.</p></li>
</ul>

<p><a id="x-28SENTO-2EEVENTSTREAM-3AMAKE-EVENTSTREAM-20FUNCTION-29"></a>
<a id="SENTO.EVENTSTREAM:MAKE-EVENTSTREAM%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.EVENTSTREAM:MAKE-EVENTSTREAM%20FUNCTION" >MAKE-EVENTSTREAM</a></span></span> <span class="locative-args">ACTOR-CONTEXT &amp;REST CONFIG</span></span></p>

<p>Creating an eventstream is done by the <a href="#SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%20CLASS" title="SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM CLASS"><code>asys:actor-system</code></a> which is then available system wide. 
But in theory it can be created individually by just passing an <a href="#SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT%20CLASS" title="SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT CLASS"><code>ac:actor-context</code></a> (though I don't know what would be the reason to create an eventstream for the context of a single actor. Maybe to address only a certain hierarchy in the actor tree.)</p>

<ul>
<li><p><code>actor-context</code>: the <code>ac:actor-context</code> where the eventstream actor should be created in.</p></li>
<li><p><code>config</code>: is a plist with the <code>:dispatcher-id</code> key and a dispatcher id as value. Defaults to <code>:shared</code>. This dispatcher type should be used by the actor.</p></li>
</ul></li>
</ul>

<p><a id="x-28SENTO-2EEVENTSTREAM-3ASUBSCRIBE-20GENERIC-FUNCTION-29"></a>
<a id="SENTO.EVENTSTREAM:SUBSCRIBE%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#SENTO.EVENTSTREAM:SUBSCRIBE%20GENERIC-FUNCTION" >SUBSCRIBE</a></span></span> <span class="locative-args">EVENTSTREAM SUBSCRIBER &amp;OPTIONAL PATTERN</span></span></p>

<p>Subscribe to the eventstream to receive notifications of certain events or event types.</p>

<p><code>subscriber</code> must be an actor (or agent).</p>

<p>The <code>pattern</code> can be:</p>

<ul>
<li><p>nil: receive all events posted to the eventstream.</p></li>
<li><p>a type, class type: this allows to get notifications when an instance of this type, or class type is posted.
I.e. if you want to listen to all string messages posted to the ev, thewn subscribe to <code>'string</code>.
Or if you want to listen to all lists, subscribe with <code>'cons</code>.</p></li>
<li><p>a symbol or global symbol: if posted message is a symbol or global symbol then the symbols are compared (<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_eq.htm" title="EQ FUNCTION"><code>eq</code></a>).</p></li>
<li><p>a string: in which case an exact string comparison is made for a string message that is posted to the eventstream (<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_stgeq_.htm" title="STRING= FUNCTION"><code>string=</code></a>).</p></li>
<li><p>a list: if subscription if for a list structure, and the posted message is also a list structure, then a structure comparison (<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_equalp.htm" title="EQUALP FUNCTION"><code>equalp</code></a>) is made.</p></li>
</ul></li>
</ul>

<p><a id="x-28SENTO-2EEVENTSTREAM-3AUNSUBSCRIBE-20GENERIC-FUNCTION-29"></a>
<a id="SENTO.EVENTSTREAM:UNSUBSCRIBE%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#SENTO.EVENTSTREAM:UNSUBSCRIBE%20GENERIC-FUNCTION" >UNSUBSCRIBE</a></span></span> <span class="locative-args">EVENTSTREAM UNSUBSCRIBER</span></span></p>

<p>Unsubscribe from the eventstream. No more events will be received then.</p></li>
</ul>

<p><a id="x-28SENTO-2EEVENTSTREAM-3APUBLISH-20GENERIC-FUNCTION-29"></a>
<a id="SENTO.EVENTSTREAM:PUBLISH%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#SENTO.EVENTSTREAM:PUBLISH%20GENERIC-FUNCTION" >PUBLISH</a></span></span> <span class="locative-args">EVENTSTREAM MESSAGE</span></span></p>

<p>Publish an event/message to the eventstream. Subscribers may receive notification if they registered for the right message pattern.</p></li>
</ul>

<p><a id="x-28SENTO-2EEVENTSTREAM-3ASUBSCRIBE-20-28METHOD-20NIL-20-28SENTO-2EEVENTSTREAM-3AEVENTSTREAM-20SENTO-2EACTOR-3AACTOR-29-29-29"></a>
<a id="SENTO.EVENTSTREAM:SUBSCRIBE%20%28METHOD%20NIL%20%28SENTO.EVENTSTREAM:EVENTSTREAM%20SENTO.ACTOR:ACTOR%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#SENTO.EVENTSTREAM:SUBSCRIBE%20%28METHOD%20NIL%20%28SENTO.EVENTSTREAM:EVENTSTREAM%20SENTO.ACTOR:ACTOR%29%29" >SUBSCRIBE</a></span></span> <span class="locative-args">(EV-STREAM EVENTSTREAM) (SUBSCRIBER ACTOR)</span></span></p>

<p>Subscribe to <a href="#SENTO.EVENTSTREAM:EVENTSTREAM%20CLASS" title="SENTO.EVENTSTREAM:EVENTSTREAM CLASS"><code>ev:eventstream</code></a>.</p></li>
</ul>

<p><a id="x-28SENTO-2EEVENTSTREAM-3ASUBSCRIBE-20-28METHOD-20NIL-20-28SENTO-2EACTOR-SYSTEM-3AACTOR-SYSTEM-20SENTO-2EACTOR-3AACTOR-29-29-29"></a>
<a id="SENTO.EVENTSTREAM:SUBSCRIBE%20%28METHOD%20NIL%20%28SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%20SENTO.ACTOR:ACTOR%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#SENTO.EVENTSTREAM:SUBSCRIBE%20%28METHOD%20NIL%20%28SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%20SENTO.ACTOR:ACTOR%29%29" >SUBSCRIBE</a></span></span> <span class="locative-args">(SYSTEM ACTOR-SYSTEM) (SUBSCRIBER ACTOR)</span></span></p>

<p>Convenience. Allows to subscribe to <a href="#SENTO.EVENTSTREAM:EVENTSTREAM%20CLASS" title="SENTO.EVENTSTREAM:EVENTSTREAM CLASS"><code>ev:eventstream</code></a> by just providing the <a href="#SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%20CLASS" title="SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM CLASS"><code>asys:actor-system</code></a>.</p></li>
</ul>

<p><a id="x-28SENTO-2EEVENTSTREAM-3ASUBSCRIBE-20-28METHOD-20NIL-20-28SENTO-2EACTOR-3AACTOR-20SENTO-2EACTOR-3AACTOR-29-29-29"></a>
<a id="SENTO.EVENTSTREAM:SUBSCRIBE%20%28METHOD%20NIL%20%28SENTO.ACTOR:ACTOR%20SENTO.ACTOR:ACTOR%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#SENTO.EVENTSTREAM:SUBSCRIBE%20%28METHOD%20NIL%20%28SENTO.ACTOR:ACTOR%20SENTO.ACTOR:ACTOR%29%29" >SUBSCRIBE</a></span></span> <span class="locative-args">(ACTOR ACTOR) (SUBSCRIBER ACTOR)</span></span></p>

<p>Convenience. Allows to subscribe to <a href="#SENTO.EVENTSTREAM:EVENTSTREAM%20CLASS" title="SENTO.EVENTSTREAM:EVENTSTREAM CLASS"><code>ev:eventstream</code></a> by just providing the actor.</p></li>
</ul>

<p><a id="x-28SENTO-2EEVENTSTREAM-3AUNSUBSCRIBE-20-28METHOD-20NIL-20-28SENTO-2EEVENTSTREAM-3AEVENTSTREAM-20SENTO-2EACTOR-3AACTOR-29-29-29"></a>
<a id="SENTO.EVENTSTREAM:UNSUBSCRIBE%20%28METHOD%20NIL%20%28SENTO.EVENTSTREAM:EVENTSTREAM%20SENTO.ACTOR:ACTOR%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#SENTO.EVENTSTREAM:UNSUBSCRIBE%20%28METHOD%20NIL%20%28SENTO.EVENTSTREAM:EVENTSTREAM%20SENTO.ACTOR:ACTOR%29%29" >UNSUBSCRIBE</a></span></span> <span class="locative-args">(EV-STREAM EVENTSTREAM) (UNSUBSCRIBER ACTOR)</span></span></p>

<p>Unsubscribe to <a href="#SENTO.EVENTSTREAM:EVENTSTREAM%20CLASS" title="SENTO.EVENTSTREAM:EVENTSTREAM CLASS"><code>ev:eventstream</code></a>.</p></li>
</ul>

<p><a id="x-28SENTO-2EEVENTSTREAM-3AUNSUBSCRIBE-20-28METHOD-20NIL-20-28SENTO-2EACTOR-SYSTEM-3AACTOR-SYSTEM-20SENTO-2EACTOR-3AACTOR-29-29-29"></a>
<a id="SENTO.EVENTSTREAM:UNSUBSCRIBE%20%28METHOD%20NIL%20%28SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%20SENTO.ACTOR:ACTOR%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#SENTO.EVENTSTREAM:UNSUBSCRIBE%20%28METHOD%20NIL%20%28SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%20SENTO.ACTOR:ACTOR%29%29" >UNSUBSCRIBE</a></span></span> <span class="locative-args">(SYSTEM ACTOR-SYSTEM) (UNSUBSCRIBER ACTOR)</span></span></p>

<p>Convenience. Allows to unsubscribe to <a href="#SENTO.EVENTSTREAM:EVENTSTREAM%20CLASS" title="SENTO.EVENTSTREAM:EVENTSTREAM CLASS"><code>ev:eventstream</code></a> by just providing the <a href="#SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%20CLASS" title="SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM CLASS"><code>asys:actor-system</code></a>.</p></li>
</ul>

<p><a id="x-28SENTO-2EEVENTSTREAM-3AUNSUBSCRIBE-20-28METHOD-20NIL-20-28SENTO-2EACTOR-3AACTOR-20SENTO-2EACTOR-3AACTOR-29-29-29"></a>
<a id="SENTO.EVENTSTREAM:UNSUBSCRIBE%20%28METHOD%20NIL%20%28SENTO.ACTOR:ACTOR%20SENTO.ACTOR:ACTOR%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#SENTO.EVENTSTREAM:UNSUBSCRIBE%20%28METHOD%20NIL%20%28SENTO.ACTOR:ACTOR%20SENTO.ACTOR:ACTOR%29%29" >UNSUBSCRIBE</a></span></span> <span class="locative-args">(ACTOR ACTOR) (UNSUBSCRIBER ACTOR)</span></span></p>

<p>Convenience. Allows to unsubscribe to <a href="#SENTO.EVENTSTREAM:EVENTSTREAM%20CLASS" title="SENTO.EVENTSTREAM:EVENTSTREAM CLASS"><code>ev:eventstream</code></a> by just providing the actor.</p></li>
</ul>

<p><a id="x-28SENTO-2EEVENTSTREAM-3APUBLISH-20-28METHOD-20NIL-20-28SENTO-2EEVENTSTREAM-3AEVENTSTREAM-20T-29-29-29"></a>
<a id="SENTO.EVENTSTREAM:PUBLISH%20%28METHOD%20NIL%20%28SENTO.EVENTSTREAM:EVENTSTREAM%20T%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#SENTO.EVENTSTREAM:PUBLISH%20%28METHOD%20NIL%20%28SENTO.EVENTSTREAM:EVENTSTREAM%20T%29%29" >PUBLISH</a></span></span> <span class="locative-args">(EV-STREAM EVENTSTREAM) MESSAGE</span></span></p>

<p>Publish to <a href="#SENTO.EVENTSTREAM:EVENTSTREAM%20CLASS" title="SENTO.EVENTSTREAM:EVENTSTREAM CLASS"><code>ev:eventstream</code></a>.</p></li>
</ul>

<p><a id="x-28SENTO-2EEVENTSTREAM-3APUBLISH-20-28METHOD-20NIL-20-28SENTO-2EACTOR-SYSTEM-3AACTOR-SYSTEM-20T-29-29-29"></a>
<a id="SENTO.EVENTSTREAM:PUBLISH%20%28METHOD%20NIL%20%28SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%20T%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#SENTO.EVENTSTREAM:PUBLISH%20%28METHOD%20NIL%20%28SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%20T%29%29" >PUBLISH</a></span></span> <span class="locative-args">(SYSTEM ACTOR-SYSTEM) MESSAGE</span></span></p>

<p>Convenience. Allows to publish to <a href="#SENTO.EVENTSTREAM:EVENTSTREAM%20CLASS" title="SENTO.EVENTSTREAM:EVENTSTREAM CLASS"><code>ev:eventstream</code></a> by just providing the <a href="#SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%20CLASS" title="SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM CLASS"><code>asys:actor-system</code></a>.</p></li>
</ul>

<p><a id="x-28SENTO-2EEVENTSTREAM-3APUBLISH-20-28METHOD-20NIL-20-28SENTO-2EACTOR-3AACTOR-20T-29-29-29"></a>
<a id="SENTO.EVENTSTREAM:PUBLISH%20%28METHOD%20NIL%20%28SENTO.ACTOR:ACTOR%20T%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#SENTO.EVENTSTREAM:PUBLISH%20%28METHOD%20NIL%20%28SENTO.ACTOR:ACTOR%20T%29%29" >PUBLISH</a></span></span> <span class="locative-args">(ACTOR ACTOR) MESSAGE</span></span></p>

<p>Convenience. Allows to publish to <a href="#SENTO.EVENTSTREAM:EVENTSTREAM%20CLASS" title="SENTO.EVENTSTREAM:EVENTSTREAM CLASS"><code>ev:eventstream</code></a> by just providing the actor.</p></li>
</ul>

<p><a id="x-28SENTO-2ETASKS-3A-40TASKS-20MGL-PAX-3ASECTION-29"></a>
<a id="SENTO.TASKS:@TASKS%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#SENTO.EVENTSTREAM:@EVENTSTREAM%20MGL-PAX:SECTION" title="Eventstream">&#8592;</a> <a href="#SENTO.DOCS:@API%20MGL-PAX:SECTION" title="API documentation">&#8593;</a> <a href="#SENTO.CONFIG:@CONFIG%20MGL-PAX:SECTION" title="Config">&#8594;</a> <a href="#SENTO.TASKS:@TASKS%20MGL-PAX:SECTION" title="Tasks">&#8634;</a></span></span></p>

<h3><a href="#SENTO.TASKS:@TASKS%20MGL-PAX:SECTION">2.8 Tasks</a></h3>

<h6>[in package SENTO.TASKS with nicknames TASKS]</h6>

<p><a id="x-28SENTO-2ETASKS-3AWITH-CONTEXT-20MGL-PAX-3AMACRO-29"></a>
<a id="SENTO.TASKS:WITH-CONTEXT%20MGL-PAX:MACRO"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[macro]</span> <span class="reference-object"><a href="#SENTO.TASKS:WITH-CONTEXT%20MGL-PAX:MACRO" >WITH-CONTEXT</a></span></span> <span class="locative-args">(CONTEXT &amp;OPTIONAL (DISPATCHER <code>:SHARED</code>)) &amp;BODY BODY</span></span></p>

<p><code>with-context</code> creates an environment where the <code>tasks</code> package functions should be used in.
<code>context</code> can be either an <a href="#SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%20CLASS" title="SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM CLASS"><code>asys:actor-system</code></a>, an <a href="#SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT%20CLASS" title="SENTO.ACTOR-CONTEXT:ACTOR-CONTEXT CLASS"><code>ac:actor-context</code></a>, or an <a href="#SENTO.ACTOR:ACTOR%20CLASS" title="SENTO.ACTOR:ACTOR CLASS"><code>act:actor</code></a> (or subclass).
<code>dispatcher</code> specifies the dispatcher where the tasks is executed in (like thread-pool).
The tasks created using the <code>tasks</code> functions will then be created in the given context.</p>

<p>Example:</p>

<pre><code><span class="code"><span class="comment">;; create actor-system
</span><span class="paren1">(<span class="code"><i><span class="symbol">defparameter</span></i> <span class="special">*sys*</span> <span class="paren2">(<span class="code">make-actor-system</span>)</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">with-context</span></i> <span class="paren2">(<span class="code"><span class="special">*sys*</span></span>)</span>
  <span class="paren2">(<span class="code">task-yield <span class="paren3">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_330.html#IDX1006" class="symbol"><i><span class="symbol">lambda</span></i></a> <span class="paren4">(<span class="code"></span>)</span> <span class="paren4">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_63.html#IDX105" class="symbol">+</a> 1 1</span>)</span></span>)</span></span>)</span></span>)</span>

=&gt; 2 <span class="paren1">(<span class="code">2 bits, #x2, #o2, #b10</span>)</span>
</span></code></pre>

<p>Since the default <code>:shared</code> dispatcher should mainly be used for the message dispatching, 
but not so much for longer running tasks it is possible to create an actor system with additional
dispatchers. This additional dispatcher can be utilized for <code>tasks</code>. Be aware that the config as used below is merged with the <a href="#SENTO.ACTOR-SYSTEM:*DEFAULT-CONFIG*%20VARIABLE" title="SENTO.ACTOR-SYSTEM:*DEFAULT-CONFIG* VARIABLE"><code>asys:*default-config*</code></a> which means that the dispatcher <code>:foo</code> here is really an additional dispatcher.</p>

<pre><code><span class="code"><span class="comment">;; create actor-system with additional (custom) dispatcher
</span><span class="paren1">(<span class="code"><i><span class="symbol">defparameter</span></i> <span class="special">*sys*</span> <span class="paren2">(<span class="code">asys:make-actor-system '<span class="paren3">(<span class="code"><span class="keyword">:dispatchers</span> <span class="paren4">(<span class="code"><span class="keyword">:foo</span> <span class="paren5">(<span class="code"><span class="keyword">:workers</span> 16</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">with-context</span></i> <span class="paren2">(<span class="code"><span class="special">*sys*</span> <span class="keyword">:foo</span></span>)</span>
  <span class="paren2">(<span class="code">task-yield <span class="paren3">(<span class="code"><i><span class="symbol">lambda</span></i> <span class="paren4">(<span class="code"></span>)</span> <span class="paren4">(<span class="code">+ 1 1</span>)</span></span>)</span></span>)</span></span>)</span>
</span></code></pre></li>
</ul>

<p><a id="x-28SENTO-2ETASKS-3A-2ATASK-CONTEXT-2A-20VARIABLE-29"></a>
<a id="SENTO.TASKS:*TASK-CONTEXT*%20VARIABLE"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[variable]</span> <span class="reference-object"><a href="#SENTO.TASKS:*TASK-CONTEXT*%20VARIABLE" >*TASK-CONTEXT*</a></span></span> <span class="locative-args">NIL</span></span></p>

<p>Optionally set this globally to use the API without using <a href="#SENTO.TASKS:WITH-CONTEXT%20MGL-PAX:MACRO" title="SENTO.TASKS:WITH-CONTEXT MGL-PAX:MACRO"><code>with-context</code></a>.</p></li>
</ul>

<p><a id="x-28SENTO-2ETASKS-3A-2ATASK-DISPATCHER-2A-20VARIABLE-29"></a>
<a id="SENTO.TASKS:*TASK-DISPATCHER*%20VARIABLE"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[variable]</span> <span class="reference-object"><a href="#SENTO.TASKS:*TASK-DISPATCHER*%20VARIABLE" >*TASK-DISPATCHER*</a></span></span> <span class="locative-args">NIL</span></span></p>

<p>Optionally set a dispatcher id. Same applies here as for <a href="#SENTO.TASKS:*TASK-CONTEXT*%20VARIABLE" title="SENTO.TASKS:*TASK-CONTEXT* VARIABLE"><code>*task-context*</code></a>.</p></li>
</ul>

<p><a id="x-28SENTO-2ETASKS-3ATASK-YIELD-20FUNCTION-29"></a>
<a id="SENTO.TASKS:TASK-YIELD%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.TASKS:TASK-YIELD%20FUNCTION" >TASK-YIELD</a></span></span> <span class="locative-args">FUN &amp;OPTIONAL TIME-OUT</span></span></p>

<p><code>task-yield</code> runs the given function <code>fun</code> by blocking and waiting for a response from the <code>task</code>, or until the given timeout was elapsed.
<code>fun</code> must be a 0-arity function.</p>

<p>A normal response from the actor is passed back as the response value.
If the timeout elapsed the response is: <code>(values :handler-error utils:ask-timeout)</code>.</p>

<p>Example:</p>

<pre><code><span class="code"><span class="comment">;; create actor-system
</span><span class="paren1">(<span class="code"><i><span class="symbol">defparameter</span></i> <span class="special">*sys*</span> <span class="paren2">(<span class="code">make-actor-system</span>)</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">with-context</span></i> <span class="paren2">(<span class="code"><span class="special">*sys*</span></span>)</span>
  <span class="paren2">(<span class="code">task-yield <span class="paren3">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_330.html#IDX1006" class="symbol"><i><span class="symbol">lambda</span></i></a> <span class="paren4">(<span class="code"></span>)</span> <span class="paren4">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_63.html#IDX105" class="symbol">+</a> 1 1</span>)</span></span>)</span></span>)</span></span>)</span>

=&gt; 2 <span class="paren1">(<span class="code">2 bits, #x2, #o2, #b10</span>)</span></span></code></pre></li>
</ul>

<p><a id="x-28SENTO-2ETASKS-3ATASK-START-20FUNCTION-29"></a>
<a id="SENTO.TASKS:TASK-START%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.TASKS:TASK-START%20FUNCTION" >TASK-START</a></span></span> <span class="locative-args">FUN</span></span></p>

<p><code>task-start</code> runs the given function <code>fun</code> asynchronously.
<code>fun</code> must be a 0-arity function.
Use this if you don't care about any response or result, i.e. for I/O side-effects.
It returns <code>(values :ok &lt;task&gt;)</code>. `<task> is in fact an actor given back as reference.
The task is automatically stopped and removed from the context and will not be able to handle requests.</p></li>
</ul>

<p><a id="x-28SENTO-2ETASKS-3ATASK-ASYNC-20FUNCTION-29"></a>
<a id="SENTO.TASKS:TASK-ASYNC%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.TASKS:TASK-ASYNC%20FUNCTION" >TASK-ASYNC</a></span></span> <span class="locative-args">FUN &amp;KEY ON-COMPLETE-FUN</span></span></p>

<p><code>task-async</code> schedules the function <code>fun</code> for asynchronous execution.
<code>fun</code> must be a 0-arity function.
<code>on-complete-fun</code> is a 1-arity completion handler function. When called the result is delivered.
The completion handler function parameter may also be a <code>(cons :handler-error condition)</code> construct in case an error happened within the message handling.</p>

<p>Using <code>task-async</code> provides two alternatives:</p>

<ul>
<li><p>together with <a href="#SENTO.TASKS:TASK-AWAIT%20FUNCTION" title="SENTO.TASKS:TASK-AWAIT FUNCTION"><code>task-await</code></a></p></li>
<li><p>or with completion handler</p></li>
</ul>

<p>In fact it is possible to call <code>task-await</code> as well, but then you probably don't need a completion handler.
Using the completion handler makes the processing complete asynchronous.</p>

<p>The result of <code>task-async</code> is a <code>task</code>.
Store this <code>task</code> for a call to <code>task-async</code> (even with or without using <code>on-complete-fun</code>).
When <em>not</em> using <code>on-complete-fun</code> users must call either <code>task-await</code> or <a href="#SENTO.TASKS:TASK-SHUTDOWN%20FUNCTION" title="SENTO.TASKS:TASK-SHUTDOWN FUNCTION"><code>task-shutdown</code></a> for the task to be cleaned up.
When using <code>on-complete-fun</code> this is done for you.</p>

<p>Example:</p>

<pre><code><span class="code"><span class="comment">;; create actor-system
</span><span class="paren1">(<span class="code"><i><span class="symbol">defparameter</span></i> <span class="special">*sys*</span> <span class="paren2">(<span class="code">make-actor-system</span>)</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">with-context</span></i> <span class="paren2">(<span class="code"><span class="special">*sys*</span></span>)</span>
  <span class="paren2">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_141.html#IDX422" class="symbol"><i><span class="symbol">let</span></i></a> <span class="paren3">(<span class="code"><span class="paren4">(<span class="code">x <span class="paren5">(<span class="code">task-async <span class="paren6">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_330.html#IDX1006" class="symbol"><i><span class="symbol">lambda</span></i></a> <span class="paren1">(<span class="code"></span>)</span> <span class="paren1">(<span class="code">some bigger computation</span>)</span></span>)</span></span>)</span></span>)</span>
        <span class="paren4">(<span class="code">y 1</span>)</span></span>)</span>
    <span class="paren3">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_63.html#IDX105" class="symbol">+</a> <span class="paren4">(<span class="code">task-await x</span>)</span> y</span>)</span></span>)</span></span>)</span>

<span class="comment">;; use-case with `on-complete-fun`
</span><span class="paren1">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_167.html#IDX483" class="symbol"><i><span class="symbol">defun</span></i></a> my-task-completion <span class="paren2">(<span class="code">result</span>)</span>
  <span class="paren2">(<span class="code">do-something-with result</span>)</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">with-context</span></i> <span class="paren2">(<span class="code"><span class="special">*sys*</span></span>)</span>
  <span class="paren2">(<span class="code">task-async <span class="paren3">(<span class="code"><a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_330.html#IDX1006" class="symbol"><i><span class="symbol">lambda</span></i></a> <span class="paren4">(<span class="code"></span>)</span> <span class="paren4">(<span class="code">some-bigger-computation</span>)</span></span>)</span>
              <span class="keyword">:on-complete-fun</span> #'my-task-completion</span>)</span></span>)</span></span></code></pre></li>
</ul>

<p><a id="x-28SENTO-2ETASKS-3ATASK-AWAIT-20FUNCTION-29"></a>
<a id="SENTO.TASKS:TASK-AWAIT%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.TASKS:TASK-AWAIT%20FUNCTION" >TASK-AWAIT</a></span></span> <span class="locative-args">TASK &amp;OPTIONAL TIME-OUT</span></span></p>

<p><code>task-await</code> waits (by blocking) until a result has been generated for a previous <a href="#SENTO.TASKS:TASK-ASYNC%20FUNCTION" title="SENTO.TASKS:TASK-ASYNC FUNCTION"><code>task-async</code></a> by passing the <code>task</code> result of <code>task-async</code> to <code>task-await</code>.
Specify <code>time-out</code> in seconds. If <code>task-await</code> times out a <code>(cons :handler-error 'ask-timeout)</code> will be returned.
<code>task-await</code> also stops the <code>task</code> that is the result of <code>task-async</code>, so it is of no further use.</p></li>
</ul>

<p><a id="x-28SENTO-2ETASKS-3ATASK-SHUTDOWN-20FUNCTION-29"></a>
<a id="SENTO.TASKS:TASK-SHUTDOWN%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.TASKS:TASK-SHUTDOWN%20FUNCTION" >TASK-SHUTDOWN</a></span></span> <span class="locative-args">TASK</span></span></p>

<p><code>task-shutdown</code> shuts down a task in order to clean up resources.</p></li>
</ul>

<p><a id="x-28SENTO-2ETASKS-3ATASK-ASYNC-STREAM-20FUNCTION-29"></a>
<a id="SENTO.TASKS:TASK-ASYNC-STREAM%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.TASKS:TASK-ASYNC-STREAM%20FUNCTION" >TASK-ASYNC-STREAM</a></span></span> <span class="locative-args">FUN LST</span></span></p>

<p><code>task-async-stream</code> concurrently applies <code>fun</code> on all elements of <code>lst</code>.
<code>fun</code> must be a one-arity function taking an element of <code>lst</code>.</p>

<p>The concurrency depends on the number of available <code>:shared</code> dispatcher workers.
Each element of <code>lst</code> is processed by a worker of the <a href="#SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM%20CLASS" title="SENTO.ACTOR-SYSTEM:ACTOR-SYSTEM CLASS"><code>asys:actor-system</code></a>s <code>:shared</code> dispatcher.
If all workers are busy then the computation of <code>fun</code> is queued.</p>

<p>Example:</p>

<pre><code><span class="code"><span class="comment">;; create actor-system
</span><span class="paren1">(<span class="code"><i><span class="symbol">defparameter</span></i> <span class="special">*sys*</span> <span class="paren2">(<span class="code">make-actor-system</span>)</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">with-context</span></i> <span class="paren2">(<span class="code"><span class="special">*sys*</span></span>)</span>
  <span class="paren2">(<span class="code">-&gt;&gt; 
    '<span class="paren3">(<span class="code">1 2 3 4 5</span>)</span>
    <span class="paren3">(<span class="code">task-async-stream #'<a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_63.html#IDX103" class="symbol">1+</a></span>)</span>
    <span class="paren3">(<span class="code">reduce #'<a href="http://www.gnu.org/software/emacs/elisp-manual/html_node/elisp_63.html#IDX105" class="symbol">+</a></span>)</span></span>)</span></span>)</span>

=&gt; 20 <span class="paren1">(<span class="code">5 bits, #x14, #o24, #b10100</span>)</span></span></code></pre></li>
</ul>

<p><a id="x-28SENTO-2ECONFIG-3A-40CONFIG-20MGL-PAX-3ASECTION-29"></a>
<a id="SENTO.CONFIG:@CONFIG%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#SENTO.TASKS:@TASKS%20MGL-PAX:SECTION" title="Tasks">&#8592;</a> <a href="#SENTO.DOCS:@API%20MGL-PAX:SECTION" title="API documentation">&#8593;</a> <a href="#SENTO.CONFIG:@CONFIG%20MGL-PAX:SECTION" title="Config">&#8634;</a></span></span></p>

<h3><a href="#SENTO.CONFIG:@CONFIG%20MGL-PAX:SECTION">2.9 Config</a></h3>

<h6>[in package SENTO.CONFIG with nicknames CONFIG]</h6>

<p><a id="x-28SENTO-2ECONFIG-3ACONFIG-FROM-20FUNCTION-29"></a>
<a id="SENTO.CONFIG:CONFIG-FROM%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.CONFIG:CONFIG-FROM%20FUNCTION" >CONFIG-FROM</a></span></span> <span class="locative-args">CONFIG-STRING</span></span></p>

<p>Parses the given config-string, represented by common lisp s-expressions.
The config is composed of plists in a hierarchy.</p>

<p>This function parses (run through <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_rd_rd.htm" title="READ FUNCTION"><code>cl:read</code></a>) the given config string.
The config string can be generated by:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">let</span></i> <span class="paren2">(<span class="code"><span class="paren3">(<span class="code"><span class="special">*print-case*</span> <span class="keyword">:downcase</span></span>)</span></span>)</span>
  <span class="paren2">(<span class="code">prin1-to-string '<span class="paren3">(<span class="code"><i><span class="symbol">defconfig</span></i> 
                     <span class="paren4">(<span class="code"><span class="keyword">:foo</span> 1
                      <span class="keyword">:bar</span> 2</span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<p>Or just be given by reading from a file.
Notice the 'config' s-expr must start with the root <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_car_c.htm" title="CAR FUNCTION"><code>car</code></a> 'defconfig'.</p></li>
</ul>

<p><a id="x-28SENTO-2ECONFIG-3ARETRIEVE-SECTION-20FUNCTION-29"></a>
<a id="SENTO.CONFIG:RETRIEVE-SECTION%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.CONFIG:RETRIEVE-SECTION%20FUNCTION" >RETRIEVE-SECTION</a></span></span> <span class="locative-args">CONFIG SECTION</span></span></p>

<p>Retrieves the given named section which should be a (global) <a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_symbol.htm" title="SYMBOL TYPE"><code>symbol</code></a> (a key).
A section usually is a plist with additional configs or sub sections.
This function looks only in the root hierarchy of the given config.</p></li>
</ul>

<p><a id="x-28SENTO-2ECONFIG-3ARETRIEVE-VALUE-20FUNCTION-29"></a>
<a id="SENTO.CONFIG:RETRIEVE-VALUE%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.CONFIG:RETRIEVE-VALUE%20FUNCTION" >RETRIEVE-VALUE</a></span></span> <span class="locative-args">SECTION KEY</span></span></p>

<p>Retrieves the value for the given key and section.</p></li>
</ul>

<p><a id="x-28SENTO-2ECONFIG-3ARETRIEVE-KEYS-20FUNCTION-29"></a>
<a id="SENTO.CONFIG:RETRIEVE-KEYS%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.CONFIG:RETRIEVE-KEYS%20FUNCTION" >RETRIEVE-KEYS</a></span></span> <span class="locative-args">CONFIG</span></span></p>

<p>Retrieves all section keys</p></li>
</ul>

<p><a id="x-28SENTO-2ECONFIG-3AMERGE-CONFIG-20FUNCTION-29"></a>
<a id="SENTO.CONFIG:MERGE-CONFIG%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#SENTO.CONFIG:MERGE-CONFIG%20FUNCTION" >MERGE-CONFIG</a></span></span> <span class="locative-args">CONFIG FALLBACK-CONFIG</span></span></p>

<p>Merges config. 
<code>config</code> specifies a config that overrides what exists in <code>fallback-config</code>.
<code>fallback-config</code> is a default. If something doesn't exist in <code>config</code> it is taken from <code>fallback-config</code>.
Both <code>config</code> and <code>fallback-config</code> must be plists, or a 'config' that was the output of <a href="#SENTO.CONFIG:CONFIG-FROM%20FUNCTION" title="SENTO.CONFIG:CONFIG-FROM FUNCTION"><code>config-from</code></a>.</p></li>
</ul>
  </div>
</div>
<script>$('#page-toc').toc({'selectors': 'h1,h2,h3,h4'});</script>
</body>
</html>
